<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Giorgio — Elettricista & Antennista</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0A2E5C">
<style>
:root{--brand:#0A2E5C;--accent:#F7931E;--bg:#f6f8fb;--card:#fff;--line:#e6e8ef;--muted:#64748b}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a}

/* Header + Tabs */
header{position:sticky;top:0;z-index:20;background:var(--brand);color:#fff;padding:10px 14px;display:flex;gap:12px;align-items:center}
.logo{width:46px;height:46px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#fff}
h1{margin:0;font-size:18px}
header small{opacity:.9}
nav{position:sticky;top:66px;z-index:19;display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bg)}
.tab{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Layout */
main{padding:12px;max-width:1100px;margin:0 auto}
main>section{display:none}
main>section.active{display:block}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.card>.head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.card>.body{padding:12px}
.split{display:grid;gap:12px;grid-template-columns:330px 1fr}
@media(max-width:930px){.split{grid-template-columns:1fr}}
.list{max-height:62vh;overflow:auto;display:flex;flex-direction:column}
.row{padding:10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:8px;cursor:pointer}
.row:hover{background:#f9fafb}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.grid3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
label{display:block;margin:8px 0 6px;font-weight:600}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{min-height:110px}
.btn{padding:9px 13px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.danger{color:#ef4444;border-color:#ef4444;background:#fff}
.actions{display:flex;gap:8px;flex-wrap:wrap}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid var(--line);padding:8px}
th{background:#f8fafc;text-align:left}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.badge.warn{border-color:#f59e0b;color:#b45309;background:#fffbeb}
.badge.danger{border-color:#ef4444;color:#991b1b;background:#fef2f2}
.note{font-size:12px;color:var(--muted)}

/* Firma: scrittura mobile stabile (modale + canvas) */
canvas[data-signature]{touch-action:none;-ms-touch-action:none}
.sig-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0006;z-index:9999}
.sig-modal.open{display:flex}
.sig-box{background:#fff;width:min(720px,92vw);border-radius:14px;padding:12px}
.sig-box canvas{width:100%;height:280px;border:2px dashed #e5e7eb;border-radius:10px}

/* Stampa */
@media print{
  header,nav,.no-print{display:none!important}
  .printSheet{display:block!important;width:210mm;min-height:297mm;padding:16mm;margin:0 auto;color:#000}
  .ph{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .ph img{width:55px;height:55px;border-radius:50%;border:2px solid #000;object-fit:cover}
  .pt{font-weight:700;font-size:18px}
  .pm{font-size:12px;opacity:.8}
  .terms{font-size:11px;margin-top:8px}
  table,th,td{border:1px solid #000}
  /* firme a destra */
  .sign-row{display:flex;justify-content:flex-end;gap:24px;margin-top:16px}
  .sign{width:220px;text-align:center}
  .sign img{width:100%;max-height:90px;object-fit:contain;border:1px solid #000;padding:6px;background:#fff}
  .sign .cap{margin-top:6px;font-size:12px}
}
</style>
</head>
<body>
<header>
  <img id="appLogo" class="logo" alt="Logo">
  <div>
    <h1 id="ttl">Giorgio — Elettricista & Antennista</h1>
    <small id="tel">Tel. +39 351 796 9013</small> ·
    <small>v29 — Preventivi · Interventi · Impostazioni</small>
  </div>
</header>

<nav>
  <button class="tab active" data-tab="pv">Preventivi</button>
  <button class="tab" data-tab="iv">Interventi</button>
  <button class="tab" data-tab="st">Impostazioni</button>
</nav>

<main>
  <!-- PREVENTIVI -->
  <section id="pv" class="active">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Preventivi</strong>
          <div class="actions">
            <select id="pv-filter" class="btn">
              <option value="all">Tutti (scadenza)</option>
              <option value="due">In scadenza (7 giorni)</option>
              <option value="expired">Scaduti</option>
            </select>
            <button class="btn" id="pv-exp">Esporta</button>
            <label class="btn"><input type="file" id="pv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body">
          <input id="pv-search" placeholder="Cerca: numero, cliente, oggetto…">
        </div>
        <div class="body list" id="pv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Preventivo</strong>
          <div class="actions">
            <button class="btn" id="pv-new">Nuovo</button>
            <button class="btn" id="pv-dup">Duplica</button>
            <button class="btn primary" id="pv-save">Salva</button>
            <button class="btn" id="pv-to-iv">Crea intervento</button>
            <button class="btn danger" id="pv-del">Elimina</button>
            <button class="btn" id="pv-print">Stampa / PDF</button>
            <button class="btn" id="pv-share">Condividi</button>
          </div>
        </div>
        <div class="body">
          <input type="hidden" id="pv-id">
          <div class="grid3">
            <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
            <div><label>Data</label><input type="date" id="pv-date"></div>
            <div><label>Scadenza</label><input type="date" id="pv-expdate"></div>
          </div>
          <div class="grid3">
            <div>
              <label>Unità manodopera</label>
              <select id="pv-lab-unit"><option value="h">Oraria</option><option value="d">Giornaliera</option></select>
            </div>
            <div><label>Q.tà manodopera</label><input type="number" id="pv-lab-qty" step="0.25" value="0" inputmode="decimal"></div>
            <div><label>Tariffa (€ / unità)</label><input type="number" id="pv-lab-rate" step="0.01" value="0" inputmode="decimal"></div>
          </div>
          <div class="grid2">
            <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
            <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
          </div>
          <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

          <label>Materiali / Servizi</label>
          <table id="pv-rows">
            <thead><tr><th>Descrizione</th><th style="width:92px">Q.tà</th><th style="width:120px">Prezzo</th><th style="width:46px">×</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="actions">
            <button class="btn" id="pv-add">+ Riga</button>
            <button class="btn" id="pv-clear">Svuota righe</button>
          </div>

          <div class="grid3">
            <div><label>Sconto %</label><input type="number" id="pv-sco" step="0.1" value="0" inputmode="decimal"></div>
            <div><label>Maggiorazione %</label><input type="number" id="pv-mag" step="0.1" value="0" inputmode="decimal"></div>
            <div><label>Totale</label><input id="pv-tot" readonly></div>
          </div>

          <div class="grid3">
            <div class="card"><div class="body"><div class="note">Materiali</div><div id="pv-mat">€ 0,00</div></div></div>
            <div class="card"><div class="body"><div class="note">Manodopera</div><div id="pv-lab">€ 0,00</div></div></div>
            <div class="card"><div class="body"><div class="note">Imponibile (materiali + manodopera)</div><div id="pv-imp">€ 0,00</div></div></div>
          </div>

          <!-- FIRMA CLIENTE -->
          <div data-signature-wrap style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>Firma Cliente ✍️</strong>
              <span data-sig-badge class="badge">Non firmato</span>
            </div>
            <div class="sig-modal"><div class="sig-box"><canvas data-signature></canvas></div></div>
            <div class="actions">
              <button class="btn" data-sig-open>Apri</button>
              <button class="btn" data-sig-clear>Pulisci</button>
              <button class="btn" data-sig-close>Chiudi</button>
            </div>
            <input type="hidden" name="firma_cliente" data-sig-data>
          </div>

          <!-- FIRMA TECNICO -->
          <div data-signature-wrap style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>Firma Tecnico ✍️</strong>
              <span data-sig-badge class="badge">Non firmato</span>
            </div>
            <div class="sig-modal"><div class="sig-box"><canvas data-signature></canvas></div></div>
            <div class="actions">
              <button class="btn" data-sig-open>Apri</button>
              <button class="btn" data-sig-clear>Pulisci</button>
              <button class="btn" data-sig-close>Chiudi</button>
            </div>
            <input type="hidden" name="firma_tecnico" data-sig-data>
          </div>

          <div class="note" style="margin-top:8px">
            Termini: validità preventivo 30 giorni salvo diversa indicazione. Prezzi al netto di urgenze/trasferte se non indicati.
            Materiali garantiti se specificati. Pagamento alla consegna salvo accordi scritti. Le firme equivalgono a firma digitale.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- INTERVENTI -->
  <section id="iv">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Interventi</strong>
          <div class="actions">
            <button class="btn" id="iv-exp">Esporta</button>
            <label class="btn"><input type="file" id="iv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body list" id="iv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Intervento</strong>
          <div class="actions">
            <button class="btn" id="iv-new">Nuovo</button>
            <button class="btn" id="iv-dup">Duplica</button>
            <button class="btn primary" id="iv-save">Salva</button>
            <button class="btn danger" id="iv-del">Elimina</button>
          </div>
        </div>
        <div class="body">
          <input type="hidden" id="iv-id">
          <div class="grid3">
            <div><label>Numero</label><input id="iv-num" placeholder="INT-0001"></div>
            <div><label>Data</label><input type="date" id="iv-date"></div>
            <div><label>Stato</label><select id="iv-st"><option>Aperto</option><option>In corso</option><option>Chiuso</option></select></div>
          </div>
          <div class="grid2">
            <div><label>Cliente</label><input id="iv-cli" placeholder="Nome cliente"></div>
            <div><label>Contatto</label><input id="iv-con" placeholder="Telefono / Email"></div>
          </div>
          <label>Descrizione</label>
          <textarea id="iv-des" placeholder="Diagnosi, materiali usati, note…"></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- IMPOSTAZIONI -->
  <section id="st">
    <div class="card">
      <div class="head"><strong>Impostazioni</strong></div>
      <div class="body">
        <div class="grid2">
          <div><label>Intestazione</label><input id="st-rag" value="Giorgio — Elettricista & Antennista"></div>
          <div><label>Colore brand</label><input id="st-brand" value="#0A2E5C"></div>
        </div>
        <div class="grid2">
          <div><label>Telefono</label><input id="st-phone" value="+39 351 796 9013"></div>
          <div><label>Note di stampa</label><input id="st-note" placeholder="Indirizzo, orari, condizioni…"></div>
        </div>
        <label>Logo JPG/PNG</label>
        <input type="file" id="st-file" accept="image/png,image/jpeg">
        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="st-save">Salva impostazioni</button>
          <button class="btn" id="st-reset">Ripristina predefiniti</button>
          <button class="btn danger" id="st-wipe">Cancella tutti i dati</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PRINT -->
  <section id="print" class="no-print" style="display:none">
    <div id="sheet" class="printSheet"></div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const S={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:k=>localStorage.removeItem(k)};
const today=()=>new Date().toISOString().slice(0,10);
const uuid=()=>crypto.randomUUID();
const num=v=>isNaN(parseFloat(v))?0:parseFloat(v);
const fmt=n=>(Math.round(n*100)/100).toFixed(2).replace('.',',');

/* ===== Tabs ===== */
$$('nav .tab').forEach(b=>b.addEventListener('click',()=>{
  $$('nav .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $$('main>section').forEach(s=>s.classList.toggle('active', s.id===b.dataset.tab));
}));

/* ===== Brand/Impostazioni ===== */
function initBrand(){
  const rag=S.get('rag','Giorgio — Elettricista & Antennista');
  const brand=S.get('brand','#0A2E5C');
  const phone=S.get('phone','+39 351 796 9013');
  const logo=S.get('logo',null);
  $('#ttl').textContent=rag;
  $('#tel').textContent=phone?('Tel. '+phone):'';
  document.documentElement.style.setProperty('--brand',brand);
  $('#appLogo').src = logo || 'icona-192.png';
  $('#st-rag').value=rag; $('#st-brand').value=brand; $('#st-phone').value=phone; $('#st-note').value=S.get('note','');
}
$('#st-save').onclick=()=>{
  S.set('rag',$('#st-rag').value.trim()||'Giorgio — Elettricista & Antennista');
  S.set('brand',$('#st-brand').value.trim()||'#0A2E5C');
  S.set('phone',$('#st-phone').value.trim());
  S.set('note',$('#st-note').value.trim());
  initBrand(); alert('Impostazioni salvate ✅');
};
$('#st-reset').onclick=()=>{['rag','brand','phone','note','logo'].forEach(S.del); initBrand();};
$('#st-file').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  if(!/^image\/(png|jpeg)$/.test(f.type)){alert('Carica PNG o JPG'); return}
  const r=new FileReader(); r.onload=ev=>{S.set('logo',ev.target.result); initBrand();}; r.readAsDataURL(f);
};
$('#st-wipe').onclick=()=>{ if(confirm('Cancellare TUTTI i dati?')){ localStorage.clear(); location.reload(); } };

/* ===== Store ===== */
const getPV=()=>S.get('pv',[]), setPV=a=>S.set('pv',a);
const getIV=()=>S.get('iv',[]), setIV=a=>S.set('iv',a);

/* ===== Preventivi: righe & calcoli ===== */
function addRow(desc='',q=1,pr=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="d" value="${desc}"></td>
  <td><input type="number" class="q" step="0.01" inputmode="decimal" value="${q}"></td>
  <td><input type="number" class="p" step="0.01" inputmode="decimal" value="${pr}"></td>
  <td><button class="btn danger x" type="button">×</button></td>`;
  $('#pv-rows tbody').appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',calc));
  tr.querySelector('.x').onclick=()=>{tr.remove();calc()};
}
function rows(){return [...$('#pv-rows tbody').querySelectorAll('tr')].map(tr=>({
  desc:tr.querySelector('.d').value.trim(), qty:num(tr.querySelector('.q').value), price:num(tr.querySelector('.p').value)
})).filter(r=>r.desc||r.qty||r.price)}
function calc(){
  const r=rows();
  const mat=r.reduce((s,v)=>s+v.qty*v.price,0);
  const labQty=num($('#pv-lab-qty').value), labRate=num($('#pv-lab-rate').value);
  const lab=labQty*labRate;
  const imp=mat+lab;
  const sPerc=num($('#pv-sco').value), mPerc=num($('#pv-mag').value);
  const afterDiscount=imp - (imp*sPerc/100);
  const total=afterDiscount + (afterDiscount*mPerc/100);
  $('#pv-mat').textContent='€ '+fmt(mat);
  $('#pv-lab').textContent='€ '+fmt(lab);
  $('#pv-imp').textContent='€ '+fmt(imp);
  $('#pv-tot').value='€ '+fmt(total);
}
$('#pv-add').onclick=()=>addRow();
$('#pv-clear').onclick=()=>{$('#pv-rows tbody').innerHTML=''; calc();}
['pv-lab-qty','pv-lab-rate','pv-sco','pv-mag'].forEach(id=>$('#'+id).addEventListener('input',calc));

/* ===== Preventivi CRUD ===== */
function newPV(){
  $('#pv-id').value='';
  $('#pv-num').value='PV-'+String(getPV().length+1).padStart(4,'0');
  $('#pv-date').value=today();
  const d=new Date(); d.setDate(d.getDate()+30);
  $('#pv-expdate').value=d.toISOString().slice(0,10);
  $('#pv-obj').value=''; $('#pv-lab-qty').value=0; $('#pv-lab-rate').value=0; $('#pv-lab-unit').value='h';
  $('#pv-sco').value=0; $('#pv-mag').value=0;
  $('#pv-rows tbody').innerHTML=''; addRow();
  calc();
}
function readPV(){
  return {
    id:$('#pv-id').value||crypto.randomUUID(),
    numero:$('#pv-num').value.trim(),
    data:$('#pv-date').value,
    scadenza:$('#pv-expdate').value,
    unita:$('#pv-lab-unit').value,
    labqty:num($('#pv-lab-qty').value),
    labrate:num($('#pv-lab-rate').value),
    cliente:$('#pv-cli').value.trim(),
    contatto:$('#pv-con').value.trim(),
    oggetto:$('#pv-obj').value.trim(),
    voci:rows(),
    sconto:num($('#pv-sco').value),
    maggiorazione:num($('#pv-mag').value),
    totale:($('#pv-tot').value||'').replace('€','').trim(),
    sigC: document.querySelector('[name="firma_cliente"]')?.value || '',
    sigT: document.querySelector('[name="firma_tecnico"]')?.value || ''
  };
}
function fillPV(id){
  const p=getPV().find(x=>x.id===id); if(!p) return;
  $('#pv-id').value=p.id; $('#pv-num').value=p.numero; $('#pv-date').value=p.data; $('#pv-expdate').value=p.scadenza||'';
  $('#pv-lab-unit').value=p.unita||'h'; $('#pv-lab-qty').value=p.labqty??0; $('#pv-lab-rate').value=p.labrate??0;
  $('#pv-cli').value=p.cliente||''; $('#pv-con').value=p.contatto||''; $('#pv-obj').value=p.oggetto||'';
  $('#pv-rows tbody').innerHTML=''; (p.voci||[]).forEach(v=>addRow(v.desc,v.qty,v.price));
  $('#pv-sco').value=p.sconto??0; $('#pv-mag').value=p.maggiorazione??0;
  if(p.sigC) document.querySelectorAll('[name="firma_cliente"]').forEach(i=>i.value=p.sigC);
  if(p.sigT) document.querySelectorAll('[name="firma_tecnico"]').forEach(i=>i.value=p.sigT);
  calc();
}
function savePV(){
  const r=readPV(); const arr=getPV(); const i=arr.findIndex(x=>x.id===r.id);
  if(i>=0) arr[i]=r; else arr.unshift(r);
  setPV(arr); renderPV(); fillPV(r.id); alert('Preventivo salvato ✅');
}
function dupPV(){ const r=readPV(); r.id=crypto.randomUUID(); r.numero=r.numero+'-copy'; const arr=getPV(); arr.unshift(r); setPV(arr); renderPV(); fillPV(r.id); }
function delPV(){ const id=$('#pv-id').value; if(!id) return; if(!confirm('Eliminare questo preventivo?')) return;
  const arr=getPV().filter(x=>x.id!==id); setPV(arr); renderPV(); arr.length?fillPV(arr[0].id):newPV(); }

/* ===== Lista + filtri scadenza ===== */
function statusBadge(p){
  const now=new Date(); const exp=new Date(p.
