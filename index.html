<!doctype html>
<html lang="it">
<head>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a3a66">
<link rel="icon" href="icona-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="icona-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestionale Giorgio — Preventivi & Interventi</title>
<style>
:root{
  --brand:#0a3a66; --brand-2:#ff9900; --text:#0f172a; --muted:#64748b;
  --line:#e5e7eb; --bg:#f6f8fb; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:var(--text);background:var(--bg)}
.container{max-width:980px;margin-inline:auto;padding:16px}
.header{background:var(--brand);color:#fff;padding:14px 16px;margin-bottom:12px}
.header h1{margin:0;font-size:20px}
.header small{opacity:.9}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted);display:block;margin:4px 2px}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
input[readonly]{background:#f8fafc}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn.danger{background:#fff;color:#b91c1c;border-color:#fca5a5}
.btn.ghost{background:#f8fafc}
.badge{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:12px}
table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--line)}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
th{background:#f8fafc;font-weight:600;color:#334155}
td:last-child,th:last-child{text-align:center;width:48px}
tr:last-child td{border-bottom:none}
.totals{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.totals .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#f8fafc}
.totals .big{font-size:18px;font-weight:700}
.hl{font-weight:700}
.sig-box{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:12px}
.sig-head{font-weight:700;margin-bottom:8px}
.sig-actions{display:flex;gap:8px;flex-wrap:wrap}
.sig-badge{font-weight:600;margin-left:8px;color:#9ca3af}

/* Signature modal */
.sig-modal[hidden]{display:none}
.sig-modal{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px}
.sig-panel{background:#fff;width:min(900px,96vw);height:min(80vh,600px);border-radius:14px;border:1px solid var(--line);display:flex;flex-direction:column;overflow:hidden}
.sig-toolbar{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line);background:#f8fafc}
.sig-toolbar .spacer{flex:1}
#sig-canvas{flex:1;background:#fff;touch-action:none;display:block;width:100%;height:100%}
.sig-hint{padding:8px;font-size:12px;color:#64748b;border-top:1px solid var(--line);background:#fafafa}

/* Print */
@media print{
  .no-print{display:none !important}
  body{background:#fff}
  .card{border:none}
}
</style>
</head>
<body>
  <div class="header no-print">
    <h1>Giorgio — Elettricista & Antennista</h1>
    <small>Tel. +39 351 796 9013</small>
  </div>

  <div class="container">
    <!-- BARRA AZIONI -->
    <div class="card no-print">
      <div class="btns">
        <button class="btn" id="btn-new">Nuovo</button>
        <button class="btn primary" id="btn-save">Salva</button>
        <button class="btn" id="btn-print">Stampa / PDF</button>
        <button class="btn" id="btn-share">Condividi</button>
        <span class="badge" id="badge-state">Bozza</span>
      </div>
    </div>

    <!-- INTESTAZIONE -->
    <div class="card">
      <div class="row">
        <div>
          <label>Numero</label>
          <input id="pv-num" readonly>
        </div>
        <div>
          <label>Data</label>
          <input id="pv-date" type="date">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Scadenza</label>
          <input id="pv-exp" type="date">
        </div>
        <div>
          <label>Stato</label>
          <input id="pv-stato" value="Bozza" readonly>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Cliente</label>
          <input id="pv-cliente" placeholder="Nome cliente">
        </div>
        <div>
          <label>Contatto</label>
          <input id="pv-contatto" placeholder="Telefono / Email">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Oggetto</label>
          <input id="pv-ogg" placeholder="Oggetto del preventivo">
        </div>
        <div class="row" style="gap:10px">
          <div>
            <label>manodopera</label>
            <select id="tipo-mdp">
              <option value="oraria">Oraria</option>
              <option value="giornaliera">Giornaliera</option>
            </select>
          </div>
          <div>
            <label>Q.tà manodopera</label>
            <input id="q-mdp" type="number" min="0" step="0.25" value="0">
          </div>
          <div>
            <label>Tariffa (€/unità)</label>
            <input id="tar-mdp" type="number" min="0" step="0.01" value="0">
          </div>
        </div>
      </div>
    </div>

    <!-- MATERIALI / SERVIZI -->
    <div class="card">
      <h3 style="margin:2px 0 10px">Materiali / Servizi</h3>
      <table id="tab">
        <thead>
          <tr><th>Descrizione</th><th style="width:110px">Q.tà</th><th style="width:140px">Prezzo</th><th>×</th></tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td><input placeholder="Descrizione"></td>
            <td><input type="number" min="0" step="1" value="1"></td>
            <td><input type="number" min="0" step="0.01" value="0"></td>
            <td><button class="btn danger" data-del>✕</button></td>
          </tr>
        </tbody>
      </table>
      <div class="btns no-print" style="margin-top:10px">
        <button class="btn" id="add-row">+ Riga</button>
        <button class="btn" id="clr-rows">Svuota righe</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Sconto %</label>
          <input id="sconto" type="number" min="0" max="100" step="0.1" value="0">
        </div>
        <div>
          <label>Maggiorazione %</label>
          <input id="magg" type="number" min="0" max="100" step="0.1" value="0">
        </div>
        <div>
          <label>Totale provvisorio (€)</label>
          <input id="tot-prov" readonly>
        </div>
      </div>

      <div class="totals" style="margin-top:10px">
        <div class="box">
          <div>Materiali</div>
          <div class="big" id="tot-mat">€ 0,00</div>
        </div>
        <div class="box">
          <div>Manodopera</div>
          <div class="big" id="tot-mdp">€ 0,00</div>
          <div style="font-size:12px;color:var(--muted)" id="mdp-note">0 × 0,00 €/ora</div>
        </div>
        <div class="box">
          <div>Imponibile <span class="hl">(materiali + manodopera)</span></div>
          <div class="big" id="impon">€ 0,00</div>
        </div>
        <div class="box">
          <div>Totale</div>
          <div class="big" id="totale">€ 0,00</div>
        </div>
      </div>

      <div class="row-3" style="margin-top:10px">
        <div>
          <label>Acconto %</label>
          <input id="acc-perc" type="number" min="0" max="100" step="1" value="0">
        </div>
        <div>
          <label>Acconto €</label>
          <input id="acc-eur" type="number" min="0" step="0.01" value="0">
        </div>
        <div>
          <label>Saldo €</label>
          <input id="saldo" readonly>
        </div>
      </div>
    </div>

    <!-- FIRME -->
    <div class="card">
      <div class="sig-box">
        <div class="sig-head">Firma Cliente ✍️ <span id="sigc-badge" class="sig-badge">Non firmato</span></div>
        <div class="sig-actions">
          <button type="button" class="btn" data-sig-open="cli">Apri</button>
          <button type="button" class="btn" data-sig-clear="cli">Pulisci</button>
          <button type="button" class="btn" data-sig-close="cli">Chiudi</button>
        </div>
        <input type="hidden" id="sigc-data">
      </div>

      <div class="sig-box">
        <div class="sig-head">Firma Tecnico ✍️ <span id="sigt-badge" class="sig-badge">Non firmato</span></div>
        <div class="sig-actions">
          <button type="button" class="btn" data-sig-open="tec">Apri</button>
          <button type="button" class="btn" data-sig-clear="tec">Pulisci</button>
          <button type="button" class="btn" data-sig-close="tec">Chiudi</button>
        </div>
        <input type="hidden" id="sigt-data">
      </div>
    </div>

    <!-- TERMINI -->
    <div class="card">
      <h3 style="margin:2px 0 10px">Termini essenziali</h3>
      <ul style="margin:0 0 0 18px;padding:0;line-height:1.5">
        <li>Validità del preventivo: <b>30 giorni</b> salvo diversa indicazione.</li>
        <li>I prezzi includono materiali e manodopera indicati in dettaglio.</li>
        <li>L’eventuale acconto richiesto è indicato; il saldo è dovuto alla consegna/lavoro ultimato.</li>
        <li>Materiali garantiti solo se specificato per iscritto.</li>
        <li>Eventuali extra/urgenze si concordano e si fatturano a parte.</li>
        <li>Le firme equivalgono a firma digitale per accettazione.</li>
      </ul>
    </div>
  </div>

  <!-- MODALE FIRMA (una sola, riutilizzabile) -->
  <div id="sig-modal" class="sig-modal" hidden>
    <div class="sig-panel">
      <div class="sig-toolbar">
        <strong id="sig-title">Firma</strong>
        <div class="spacer"></div>
        <button type="button" id="sig-done" class="btn primary">Salva</button>
        <button type="button" id="sig-clear" class="btn">Pulisci</button>
        <button type="button" id="sig-cancel" class="btn danger">Chiudi</button>
      </div>
      <canvas id="sig-canvas"></canvas>
      <div class="sig-hint">Firma con dito/mouse. (La pagina non scorrerà durante la firma)</div>
    </div>
  </div>

<script>
(()=>{'use strict';
const qs=(s,e=document)=>e.querySelector(s), qsa=(s,e=document)=>[...e.querySelectorAll(s)];
const fmt = n => (new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'})).format(+n||0);

// ---------- Numerazione automatica + date ----------
const numEl=qs('#pv-num'), dateEl=qs('#pv-date'), expEl=qs('#pv-exp');
function pad(n){return String(n).padStart(4,'0')}
function nextNumber(){
  const k='pvCounter'; const v= +(localStorage.getItem(k) || 0) + 1;
  localStorage.setItem(k, v); return `PV-${pad(v)}`;
}
function setTodayAndExpiry(){
  const d=new Date(); const iso=(x)=>x.toISOString().slice(0,10);
  dateEl.value = iso(d);
  const e=new Date(d); e.setDate(e.getDate()+30);
  expEl.value = iso(e);
}
function newDoc(){
  numEl.value = nextNumber();
  setTodayAndExpiry();
  qs('#pv-stato').value='Bozza'; qs('#badge-state').textContent='Bozza';
  // reset campi base
  ['pv-cliente','pv-contatto','pv-ogg'].forEach(id=>qs('#'+id).value='');
  qs('#tipo-mdp').value='oraria'; qs('#q-mdp').value=0; qs('#tar-mdp').value=0;
  // reset tabella
  const tbody=qs('#tbody'); tbody.innerHTML='';
  addRow(); // una riga vuota
  // reset calcoli
  qs('#sconto').value=0; qs('#magg').value=0; qs('#acc-perc').value=0; qs('#acc-eur').value=0;
  // reset firme
  ['cli','tec'].forEach(w=>{input(w).value=''; badge(w).textContent='Non firmato';});
  calc();
}

// ---------- Tabella materiali ----------
function addRow(desc='',q=1,p=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input placeholder="Descrizione" value="${desc}"></td>
                <td><input type="number" min="0" step="1" value="${q}"></td>
                <td><input type="number" min="0" step="0.01" value="${p}"></td>
                <td><button class="btn danger" data-del>✕</button></td>`;
  qs('#tbody').appendChild(tr);
}
qs('#add-row').onclick=()=>{addRow();};
qs('#clr-rows').onclick=()=>{qs('#tbody').innerHTML=''; addRow(); calc();};
qs('#tbody').addEventListener('click',e=>{
  if(e.target.matches('[data-del]')){
    e.target.closest('tr').remove(); if(!qs('#tbody tr')) addRow(); calc();
  }
});
document.addEventListener('input',e=>{
  if(e.target.closest('#tbody') || ['#q-mdp','#tar-mdp','#sconto','#magg','#acc-perc','#acc-eur','#tipo-mdp'].some(sel=>e.target.matches(sel.replace('#','') ? sel : sel))){
    calc();
  }
});

// ---------- Calcoli ----------
function sumMaterials(){
  let s=0; qsa('#tbody tr').forEach(tr=>{
    const q=+tr.children[1].querySelector('input').value||0;
    const p=+tr.children[2].querySelector('input').value||0;
    s+=q*p;
  }); return s;
}
function calc(){
  const mat=sumMaterials();
  const q=+qs('#q-mdp').value||0, t=+qs('#tar-mdp').value||0;
  const tipo=qs('#tipo-mdp').value;
  const mdp = q * t;
  const impon = mat + mdp;

  const sconto=+qs('#sconto').value||0, maggior=+qs('#magg').value||0;
  let totale = impon;
  if(sconto>0) totale -= impon*(sconto/100);
  if(maggior>0) totale += impon*(maggior/100);

  qs('#tot-mat').textContent=fmt(mat);
  qs('#tot-mdp').textContent=fmt(mdp);
  qs('#mdp-note').textContent = `${q} × ${fmt(t)} €/${tipo==='oraria'?'ora':'giorno'}`;
  qs('#impon').textContent=fmt(impon);
  qs('#totale').textContent=fmt(totale);
  qs('#tot-prov').value=fmt(totale);

  // acconti/saldo
  const accPerc=+qs('#acc-perc').value||0;
  let accEur=+qs('#acc-eur').value||0;
  if(document.activeElement===qs('#acc-perc')){ // se edit % ricalcolo €
    accEur = +(totale*(accPerc/100)).toFixed(2); qs('#acc-eur').value=accEur;
  }else if(document.activeElement===qs('#acc-eur')){ // se edit € ricalcolo %
    const p = totale>0 ? (accEur/totale*100) : 0; qs('#acc-perc').value= Math.round(p);
  }else{ // sync base (es. al primo calc)
    accEur = +(totale*(accPerc/100)).toFixed(2); qs('#acc-eur').value=accEur;
  }
  qs('#saldo').value = (totale-accEur).toFixed(2);
}

// ---------- Firma (modale custom) ----------
const badge = who=>qs(who==='cli'?'#sigc-badge':'#sigt-badge');
const input = who=>qs(who==='cli'?'#sigc-data':'#sigt-data');

const Sig={
  who:null, modal:qs('#sig-modal'), canvas:qs('#sig-canvas'), ctx:null,
  drawing:false, last:[0,0], opened:false,
  init(){
    this.ctx=this.canvas.getContext('2d');
    // Bottoni
    qs('#sig-done').onclick=()=>this.save();
    qs('#sig-clear').onclick=()=>this.clear();
    qs('#sig-cancel').onclick=()=>this.close();

    // Mouse
    this.canvas.addEventListener('mousedown',e=>this.start([e.offsetX,e.offsetY]));
    window.addEventListener('mousemove',e=>this.moveMouse(e));
    window.addEventListener('mouseup',()=>this.end());

    // Touch
    this.canvas.addEventListener('touchstart',e=>{
      e.preventDefault();
      const t=e.changedTouches[0], r=this.canvas.getBoundingClientRect();
      this.start([t.clientX-r.left, t.clientY-r.top]);
    },{passive:false});
    this.canvas.addEventListener('touchmove',e=>{
      e.preventDefault();
      const t=e.changedTouches[0], r=this.canvas.getBoundingClientRect();
      this.drawTo([t.clientX-r.left, t.clientY-r.top]);
    },{passive:false});
    this.canvas.addEventListener('touchend',()=>this.end(),{passive:false});

    // Apertura dai bottoni
    qsa('[data-sig-open]').forEach(b=>b.addEventListener('click',()=>this.open(b.getAttribute('data-sig-open'))));
    qsa('[data-sig-clear]').forEach(b=>b.addEventListener('click',()=>{
      const w=b.getAttribute('data-sig-clear'); input(w).value=''; badge(w).textContent='Non firmato';
    }));
    qsa('[data-sig-close]').forEach(b=>b.addEventListener('click',()=>this.close()));

    // Chiudi esterno
    this.modal.addEventListener('click',e=>{if(e.target===this.modal) this.close();});
    window.addEventListener('keydown',e=>{if(this.opened && e.key==='Escape') this.close();});

    // Resize
    const resize=()=>{
      const r=this.canvas.getBoundingClientRect();
      const snapshot=this.ctx.getImageData(0,0,this.canvas.width||0,this.canvas.height||0);
      this.canvas.width=Math.max(300,Math.floor(r.width));
      this.canvas.height=Math.max(180,Math.floor(r.height));
      this.ctx.lineCap='round'; this.ctx.lineJoin='round'; this.ctx.lineWidth=2;
      this.ctx.strokeStyle='#111827'; this.ctx.fillStyle='#fff';
      this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
      if(snapshot.width && snapshot.height) { try{this.ctx.putImageData(snapshot,0,0);}catch{} }
    };
    new ResizeObserver(resize).observe(qs('.sig-panel'));
    window.addEventListener('orientationchange',()=>setTimeout(resize,200));
  },
  open(who){
    this.who=who; qs('#sig-title').textContent= who==='cli'?'Firma Cliente':'Firma Tecnico';
    this.modal.hidden=false; document.documentElement.style.overflow='hidden'; this.opened=true;
    const r=qs('.sig-panel').getBoundingClientRect();
    this.canvas.width=Math.floor(r.width); this.canvas.height=Math.floor(r.height-84);
    this.ctx.lineCap='round'; this.ctx.lineJoin='round'; this.ctx.lineWidth=2;
    this.ctx.strokeStyle='#111827'; this.ctx.fillStyle='#fff'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
    const data=input(who).value;
    if(data){ const img=new Image(); img.onload=()=>this.ctx.drawImage(img,0,0,this.canvas.width,this.canvas.height); img.src=data; }
  },
  close(){ this.opened=false; this.modal.hidden=true; document.documentElement.style.overflow=''; },
  clear(){ this.ctx.fillStyle='#fff'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height); },
  save(){ const data=this.canvas.toDataURL('image/png'); input(this.who).value=data; badge(this.who).textContent='Firmato'; this.close(); },
  start([x,y]){ this.drawing=true; this.last=[x,y]; },
  moveMouse(e){ if(!this.drawing) return; const r=this.canvas.getBoundingClientRect(); this.drawTo([e.clientX-r.left, e.clientY-r.top]); },
  drawTo([x,y]){ if(!this.drawing) return; this.ctx.beginPath(); this.ctx.moveTo(this.last[0],this.last[1]); this.ctx.lineTo(x,y); this.ctx.stroke(); this.last=[x,y]; },
  end(){ this.drawing=false; }
};

// ---------- Azioni top ----------
qs('#btn-print').onclick=()=>window.print();
qs('#btn-share').onclick=async()=>{
  try{
    if(navigator.share){
      await navigator.share({title:document.title,text:`Preventivo ${numEl.value}`,url:location.href});
    }else{ alert('Condivisione non supportata su questo dispositivo'); }
  }catch{}
};
qs('#btn-save').onclick=()=>{
  // Demo: salva bozza in localStorage
  const data={
    num:numEl.value,date:dateEl.value,exp:expEl.value,stato:qs('#pv-stato').value,
    cliente:qs('#pv-cliente').value,contatto:qs('#pv-contatto').value,ogg:qs('#pv-ogg').value,
    tipo:qs('#tipo-mdp').value,qmdp:+qs('#q-mdp').value, tmdp:+qs('#tar-mdp').value,
    rows: qsa('#tbody tr').map(tr=>({
      d:tr.children[0].querySelector('input').value,
      q:+tr.children[1].querySelector('input').value,
      p:+tr.children[2].querySelector('input').value
    })),
    sconto:+qs('#sconto').value, maggior:+qs('#magg').value,
    accPerc:+qs('#acc-perc').value, accEur:+qs('#acc-eur').value,
    sigc:qs('#sigc-data').value, sigt:qs('#sigt-data').value
  };
  localStorage.setItem(`pv-${data.num}`, JSON.stringify(data));
  qs('#pv-stato').value='Salvato'; qs('#badge-state').textContent='Salvato';
  alert('Salvato in locale.');
};
qs('#btn-new').onclick=()=>{ if(confirm('Creare un nuovo preventivo?')) newDoc(); };

// ---------- Avvio ----------
document.addEventListener('DOMContentLoaded',()=>{
  newDoc();
  calc();
  Sig.init();
});
})();
</script>
</body>
</html>
