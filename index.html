<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Giorgio — Elettricista & Antennista</title>

  <!-- Colore barra / tema app -->
  <meta name="theme-color" content="#001f4d" />

  <!-- Manifest & Icone PWA (usa i file che hai già nel repo) -->
  <link rel="manifest" href="/gestionale-giorgio/manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="/gestionale-giorgio/icone/icona-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="/gestionale-giorgio/icone/icona-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/gestionale-giorgio/icone/icona-512.png" />

  <style>
    :root{
      --brand:#001f4d;
      --accent:#0a2e5c;
      --muted:#6b7280;
      --bg:#f4f6fa;
      --card:#ffffff;
      --ok:#0ea5e9;
      --danger:#ef4444;
      --ring:#dbe3f2;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);font:16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    header{background:var(--brand);color:#fff;padding:18px}
    header h1{margin:0;font-size:22px}
    header small{opacity:.9}
    .wrap{max-width:980px;margin:auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);padding:16px;margin:16px 0;border:1px solid var(--ring)}
    .row{display:grid;gap:12px}
    @media(min-width:740px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}.row-4{grid-template-columns:repeat(4,1fr)}}
    label{display:block;font-weight:600;margin:6px 0;color:#111827}
    input, select, textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;outline:none
    }
    input:focus, select:focus, textarea:focus{border-color:#7aa2ff;box-shadow:0 0 0 3px rgba(122,162,255,.25)}
    .btn{
      display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:10px 16px;
      background:#e5e7eb;color:#111827;font-weight:600;cursor:pointer
    }
    .btn.primary{background:#2563eb;color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e3a8a}
    .btn.warn{background:#fee2e2;color:#b91c1c}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap}
    .badge{background:#eef2ff;color:#1e3a8a;border-radius:999px;padding:6px 12px;font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;background:#fff;border:1px solid #e5e7eb}
    th{background:#f8fafc;text-align:left}
    tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .totbox{background:#f8fafc;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .grid-mini{display:grid;gap:10px}
    @media(min-width:620px){.grid-mini{grid-template-columns:repeat(4,1fr)}}
    .sign-zone{border:2px dashed #cbd5e1;border-radius:14px;padding:14px}
    .sign-actions{display:flex;gap:10px;flex-wrap:wrap}
    .status{font-weight:700;padding:6px 12px;border-radius:999px;background:#f3f4f6}
    .status.ok{background:#dcfce7;color:#166534}
    /* STAMPA */
    @media print{
      header,.toolbar,.no-print{display:none !important}
      body{background:#fff}
      .wrap{max-width:100%;padding:0}
      .card{box-shadow:none;border:none;margin:0;padding:0}
      .terms{font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <h1>Giorgio — Elettricista & Antennista</h1>
    <small>Tel. +39 351 796 9013</small>
  </header>

  <div class="wrap">

    <div class="card">
      <div class="toolbar no-print">
        <button id="btn-nuovo" class="btn">Nuovo</button>
        <button id="btn-salva" class="btn primary">Salva</button>
        <button id="btn-stampa" class="btn ghost">Stampa / PDF</button>
        <button id="btn-condividi" class="btn">Condividi</button>
        <span id="statoBadge" class="badge">Bozza</span>
      </div>

      <div class="row row-4">
        <div>
          <label>Numero</label>
          <input id="numero" readonly />
        </div>
        <div>
          <label>Data</label>
          <input id="data" type="date" />
        </div>
        <div>
          <label>Scadenza</label>
          <input id="scadenza" type="date" />
        </div>
        <div>
          <label>Stato</label>
          <input id="stato" value="Bozza" />
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>Cliente</label>
          <input id="cliente" placeholder="Nome cliente" />
        </div>
        <div>
          <label>Contatto</label>
          <input id="contatto" placeholder="Telefono / Email" />
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label>Oggetto</label>
          <input id="oggetto" placeholder="Oggetto del preventivo" />
        </div>
        <div>
          <label>manodopera</label>
          <select id="unita">
            <option value="ora">Ora</option>
            <option value="giorno">Giorno</option>
          </select>
        </div>
        <div>
          <label>Q.tà manodopera</label>
          <input id="qtaLav" type="number" min="0" step="1" value="0" />
        </div>
      </div>

      <div class="row row-3">
        <div>
          <label>Tariffa (€/unità)</label>
          <input id="tariffa" type="number" min="0" step="0.01" value="0" />
        </div>
        <div>
          <label>Sconto %</label>
          <input id="sconto" type="number" min="0" max="100" step="1" value="0" />
        </div>
        <div>
          <label>Maggiorazione %</label>
          <input id="magg" type="number" min="0" max="100" step="1" value="0" />
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Materiali / Servizi</h3>
      <div class="no-print" style="margin:10px 0;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="add-row">+ Riga</button>
        <button class="btn warn" id="clear-rows">Svuota righe</button>
      </div>
      <div class="table-wrap">
        <table id="tab">
          <thead>
            <tr>
              <th style="width:55%">Descrizione</th>
              <th style="width:10%">Q.tà</th>
              <th style="width:20%">Prezzo</th>
              <th class="right" style="width:15%">✖</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="grid-mini">
        <div class="totbox">
          <div class="muted">Materiali</div>
          <div id="totMateriali" style="font-weight:800;font-size:18px">€ 0,00</div>
        </div>
        <div class="totbox">
          <div class="muted">Manodopera</div>
          <div id="totLavoro" style="font-weight:800;font-size:18px">€ 0,00</div>
        </div>
        <div class="totbox">
          <div class="muted">Imponibile<br><small>(materiali + manodopera)</small></div>
          <div id="imponibile" style="font-weight:800;font-size:18px">€ 0,00</div>
        </div>
        <div class="totbox">
          <div class="muted">Totale</div>
          <div id="totale" style="font-weight:800;font-size:18px">€ 0,00</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Firma Cliente ✍️</h3>
      <div class="sign-zone">
        <div class="sign-actions no-print">
          <button class="btn" id="openSignCli">Apri</button>
          <button class="btn" id="clearSignCli">Pulisci</button>
          <button class="btn" id="closeSignCli">Chiudi</button>
          <span id="statusCli" class="status">Non firmato</span>
        </div>
        <canvas id="padCli" width="700" height="200" style="width:100%;display:block;background:#fff;border-radius:10px"></canvas>
      </div>
    </div>

    <div class="card">
      <h3>Firma Tecnico ✍️</h3>
      <div class="sign-zone">
        <div class="sign-actions no-print">
          <button class="btn" id="openSignTec">Apri</button>
          <button class="btn" id="clearSignTec">Pulisci</button>
          <button class="btn" id="closeSignTec">Chiudi</button>
          <span id="statusTec" class="status">Non firmato</span>
        </div>
        <canvas id="padTec" width="700" height="200" style="width:100%;display:block;background:#fff;border-radius:10px"></canvas>
      </div>
    </div>

    <div class="card terms">
      <h3>Termini e condizioni</h3>
      <ol>
        <li><b>Pagamento:</b> 50% all’accettazione del preventivo e saldo 50% a fine lavori.</li>
        <li><b>Proprietà materiali:</b> i materiali forniti restano di proprietà dell’installatore fino al saldo completo.</li>
        <li><b>Validità:</b> il preventivo è valido 30 giorni salvo diversa indicazione.</li>
        <li><b>Urgenze/trasferte:</b> non incluse se non espressamente specificate.</li>
      </ol>
    </div>

  </div>

  <script>
  // ---------- util ----------
  const € = n => n.toLocaleString('it-IT',{style:'currency',currency:'EUR'});
  const q = s => document.querySelector(s);

  // ---------- numerazione automatica ----------
  function nextNumero(){
    const key='pv_counter';
    const last= Number(localStorage.getItem(key) || '0') + 1;
    localStorage.setItem(key, String(last));
    return 'PV-' + String(last).padStart(4,'0');
  }

  // ---------- init form ----------
  function todayISO(){const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10)}
  function plusDays(iso,days){const d=new Date(iso);d.setDate(d.getDate()+days);return d.toISOString().slice(0,10)}

  function nuovo(){
    // campi base
    q('#numero').value = nextNumero();
    const d = todayISO();
    q('#data').value = d;
    q('#scadenza').value = plusDays(d,30);
    q('#stato').value = 'Bozza';
    q('#statoBadge').textContent = 'Bozza';
    ['#cliente','#contatto','#oggetto'].forEach(s=>q(s).value='');
    q('#unita').value='ora';
    q('#qtaLav').value=0;
    q('#tariffa').value=0;
    q('#sconto').value=0;
    q('#magg').value=0;

    // tabella
    tbody.innerHTML='';
    addRow();

    // firme
    clearPad(padCli, ctxCli); padCli.dataset.enabled='0'; q('#statusCli').className='status'; q('#statusCli').textContent='Non firmato';
    clearPad(padTec, ctxTec); padTec.dataset.enabled='0'; q('#statusTec').className='status'; q('#statusTec').textContent='Non firmato';

    calc();
  }

  // ---------- tabella materiali ----------
  const tbody = q('#tbody');

  function addRow(desc='', qty=1, price=0){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="desc" placeholder="Descrizione" value="${desc}"></td>
      <td><input class="qty" type="number" min="0" step="1" value="${qty}"></td>
      <td><input class="price" type="number" min="0" step="0.01" value="${price}"></td>
      <td class="right"><button class="btn warn del">Rimuovi</button></td>
    `;
    tbody.appendChild(tr);
    tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', calc));
    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); calc(); });
  }

  function rows(){
    return [...tbody.querySelectorAll('tr')].map(tr=>{
      const qty = Number(tr.querySelector('.qty').value || 0);
      const price = Number(tr.querySelector('.price').value || 0);
      return {qty, price, sub: qty*price}
    });
  }

  function calc(){
    const mat = rows().reduce((s,r)=>s+r.sub,0);
    const lav = Number(q('#qtaLav').value||0) * Number(q('#tariffa').value||0);
    const impon = mat + lav;

    const scontoPerc = Number(q('#sconto').value||0)/100;
    const maggPerc   = Number(q('#magg').value||0)/100;

    const afterSconto = impon * (1 - scontoPerc);
    const totale = afterSconto * (1 + maggPerc);

    q('#totMateriali').textContent = €(mat);
    q('#totLavoro').textContent    = €(lav);
    q('#imponibile').textContent   = €(impon);
    q('#totale').textContent       = €(totale);
  }

  q('#add-row').addEventListener('click', ()=>addRow());
  q('#clear-rows').addEventListener('click', ()=>{tbody.innerHTML=''; addRow(); calc();});
  ['#qtaLav','#tariffa','#sconto','#magg'].forEach(s=>q(s).addEventListener('input', calc));

  // ---------- firme (canvas) ----------
  function setupPad(canvas, statusEl){
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 2.2; ctx.lineCap='round'; ctx.strokeStyle='#111827';
    let drawing=false, prev=null;

    function pos(evt){
      const r = canvas.getBoundingClientRect();
      const t = ('touches' in evt) ? evt.touches[0] : evt;
      return {x: (t.clientX-r.left) * (canvas.width/r.width), y:(t.clientY-r.top) * (canvas.height/r.height)};
    }
    function start(e){ if(canvas.dataset.enabled!=='1') return; drawing=true; prev=pos(e); e.preventDefault(); }
    function move(e){ if(!drawing || canvas.dataset.enabled!=='1') return; const p=pos(e); ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); prev=p; e.preventDefault(); }
    function end(){ drawing=false; if(canvas.dataset.enabled==='1'){ statusEl.textContent='Firmato'; statusEl.className='status ok'; } }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);
    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);

    return ctx;
  }

  function clearPad(canvas, ctx){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  const padCli = q('#padCli');
  const padTec = q('#padTec');
  const ctxCli = setupPad(padCli, q('#statusCli'));
  const ctxTec = setupPad(padTec, q('#statusTec'));

  function openPad(canvas){canvas.dataset.enabled='1';}
  function closePad(canvas){canvas.dataset.enabled='0';}

  q('#openSignCli').addEventListener('click', ()=>openPad(padCli));
  q('#clearSignCli').addEventListener('click', ()=>{ clearPad(padCli, ctxCli); q('#statusCli').textContent='Non firmato'; q('#statusCli').className='status'; });
  q('#closeSignCli').addEventListener('click', ()=>closePad(padCli));

  q('#openSignTec').addEventListener('click', ()=>openPad(padTec));
  q('#clearSignTec').addEventListener('click', ()=>{ clearPad(padTec, ctxTec); q('#statusTec').textContent='Non firmato'; q('#statusTec').className='status'; });
  q('#closeSignTec').addEventListener('click', ()=>closePad(padTec));

  // ---------- Salva / Condividi / Stampa ----------
  function snapshotPad(canvas){ return canvas.toDataURL('image/png'); }

  q('#btn-salva').addEventListener('click', ()=>{
    const data = {
      numero: q('#numero').value,
      data: q('#data').value,
      scadenza: q('#scadenza').value,
      stato: q('#stato').value,
      cliente: q('#cliente').value,
      contatto: q('#contatto').value,
      oggetto: q('#oggetto').value,
      unita: q('#unita').value,
      qtaLav: q('#qtaLav').value,
      tariffa: q('#tariffa').value,
      sconto: q('#sconto').value,
      magg: q('#magg').value,
      righe: rows(),
      totMateriali: q('#totMateriali').textContent,
      totLavoro: q('#totLavoro').textContent,
      imponibile: q('#imponibile').textContent,
      totale: q('#totale').textContent,
      firmaCli: snapshotPad(padCli),
      firmaTec: snapshotPad(padTec)
    };
    const key = 'pv_store';
    const lista = JSON.parse(localStorage.getItem(key) || '[]');
    const i = lista.findIndex(x=>x.numero===data.numero);
    if(i>=0) lista[i]=data; else lista.push(data);
    localStorage.setItem(key, JSON.stringify(lista));
    q('#statoBadge').textContent='Salvato';
    alert('Preventivo salvato sul dispositivo.');
  });

  q('#btn-condividi').addEventListener('click', ()=>{
    if(navigator.share){
      navigator.share({
        title: 'Preventivo ' + q('#numero').value,
        text: 'Preventivo ' + q('#numero').value + ' — ' + q('#cliente').value,
        url: location.href
      }).catch(()=>{});
    }else{
      alert('La condivisione nativa non è supportata da questo dispositivo.');
    }
  });

  q('#btn-stampa').addEventListener('click', ()=>window.print());
  q('#btn-nuovo').addEventListener('click', nuovo);

  // ---------- PWA: registra service worker ----------
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/gestionale-giorgio/service-worker.js')
        .then(()=> navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.update())))
        .catch(console.warn);
    });
  }

  // ---------- avvio ----------
  addRow(); // prima riga tabella
  nuovo();  // imposta numerazione e reset completo
  </script>
</body>
</html>
