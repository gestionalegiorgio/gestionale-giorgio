<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestionale Giorgio — Elettricista & Antennista</title>
<meta name="theme-color" content="#0A2E5C">
<style>
  :root{--brand:#0A2E5C;--accent:#F59E0B;--bg:#f5f7fb;--card:#fff;--line:#e5e7eb;--muted:#64748b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827}
  header{position:sticky;top:0;z-index:5;background:var(--brand);color:#fff;padding:10px 14px;border-bottom:3px solid var(--accent)}
  header .row{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#fff}
  .title{display:flex;flex-direction:column}
  .title strong{font-size:18px}
  .tabs{display:flex;gap:8px;padding:10px;background:#eef2ff;border-bottom:1px solid var(--line)}
  .tab{border:1px solid #c7d2fe;background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
  .tab.active{background:#1b3e8b;color:#fff;border-color:#1b3e8b}
  main{padding:14px;max-width:980px;margin:0 auto}
  section{display:none}
  section.active{display:block}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px; padding:14px; margin-bottom:12px}
  label{display:block;margin:6px 2px;color:#334155;font-weight:600;font-size:13px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:90px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:800px){.row2,.row3{grid-template-columns:1fr}}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .btn{padding:9px 13px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:#1e66ff;color:#fff;border-color:#1e66ff}
  .btn.warn{background:#fff3bf;border-color:#fde68a}
  .btn.danger{color:#ef4444;border-color:#ef4444}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px}
  th{background:#f8fafc;text-align:left;font-size:13px;color:#334155}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  @media (max-width:800px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .box{background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:10px}
  .kpi .val{font-weight:800}
  .signwrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:800px){.signwrap{grid-template-columns:1fr}}
  .sign{border:2px dashed var(--line);border-radius:12px;padding:10px;background:#fff}
  .sign footer{display:flex;gap:6px;margin-top:6px;align-items:center}
  .status{margin-left:auto;color:var(--muted);font-size:12px}
  .hint{color:var(--muted);font-size:12px}
  .terms{font-size:13px;color:#111827}
  .print-only{display:none}
  @media print{
    header,.tabs,.btns,.no-print{display:none!important}
    .print-only{display:block}
    body{background:#fff}
    .card{border:none}
    table,th,td{border:1px solid #000}
  }
</style>
</head>
<body>

<header>
  <div class="row">
    <img id="appLogo" class="logo" alt="Logo">
    <div class="title">
      <strong>Giorgio — Elettricista & Antennista</strong>
      <small id="hdrTel">Tel. +39 351 796 9013</small>
    </div>
  </div>
</header>

<nav class="tabs no-print">
  <button class="tab active" data-tab="pv">Preventivi</button>
  <button class="tab" data-tab="iv">Interventi</button>
  <button class="tab" data-tab="st">Impostazioni</button>
</nav>

<main>
  <!-- PREVENTIVI -->
  <section id="pv" class="active">
    <div class="card">
      <div class="btns">
        <button class="btn" id="pv-new">Nuovo</button>
        <button class="btn primary" id="pv-save">Salva</button>
        <button class="btn" id="pv-print">Stampa / PDF</button>
        <button class="btn warn" id="pv-share">Condividi</button>
      </div>

      <div class="row3">
        <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
        <div><label>Data</label><input id="pv-date" type="date"></div>
        <div><label>Scadenza</label><input id="pv-exp" type="date"></div>
      </div>

      <div class="row2">
        <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
        <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
      </div>
      <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

      <h3>Manodopera</h3>
      <div class="row3">
        <div><label>Tipo</label>
          <select id="mo-type"><option value="ora">Oraria</option><option value="giorno">Giornaliera</option></select>
        </div>
        <div><label>Q.tà</label><input id="mo-qty" type="number" min="0" step="1" value="0"></div>
        <div><label>Tariffa (€/unità)</label><input id="mo-rate" type="number" min="0" step="0.01" value="0"></div>
      </div>

      <h3>Materiali / Servizi</h3>
      <table>
        <thead><tr><th>Descrizione</th><th>Q.tà</th><th>Prezzo</th><th class="no-print">×</th></tr></thead>
        <tbody id="pv-rows"></tbody>
      </table>
      <div class="btns no-print">
        <button class="btn" id="row-add">+ Riga</button>
        <button class="btn" id="row-clr">Svuota righe</button>
      </div>

      <div class="row3">
        <div><label>Sconto %</label><input id="pv-disc" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Maggiorazione %</label><input id="pv-mark" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Totale</label><input id="pv-tot" readonly></div>
      </div>

      <div class="kpi">
        <div class="box"><div class="hint">Materiali</div><div class="val" id="k-mat">€ 0,00</div></div>
        <div class="box"><div class="hint">Manodopera</div><div class="val" id="k-mo">€ 0,00</div></div>
        <div class="box"><div class="hint">Imponibile</div><div class="val" id="k-imp">€ 0,00</div></div>
        <div class="box"><div class="hint">Totale</div><div class="val" id="k-tot">€ 0,00</div></div>
      </div>

      <div class="row3">
        <div><label>Acconto %</label><input id="pv-acp" type="number" min="0" max="100" value="50"></div>
        <div>
          <label>Acconto € <input id="pv-ace-auto" type="checkbox" checked> Auto</label>
          <input id="pv-ace" type="number" min="0" step="0.01" value="0">
        </div>
        <div><label>Saldo €</label><input id="pv-bal" type="number" min="0" step="0.01" value="0"></div>
      </div>

      <h3>Firme</h3>
      <div class="signwrap">
        <div class="sign" id="sg-cliente">
          <div class="hint"><strong>Firma Cliente</strong></div>
          <canvas hidden></canvas>
          <footer><button class="btn" data-act="open">Apri</button><button class="btn" data-act="clear">Pulisci</button><button class="btn" data-act="close">Chiudi</button><span class="status">Non firmato</span></footer>
        </div>
        <div class="sign" id="sg-tecnico">
          <div class="hint"><strong>Firma Tecnico</strong></div>
          <canvas hidden></canvas>
          <footer><button class="btn" data-act="open">Apri</button><button class="btn" data-act="clear">Pulisci</button><button class="btn" data-act="close">Chiudi</button><span class="status">Non firmato</span></footer>
        </div>
      </div>

      <div class="card">
        <div class="terms" id="terms">
          <strong>Termini:</strong> Pagamento <strong>50%</strong> all’accettazione e <strong>50%</strong> a fine lavori.
          Il materiale resta di proprietà dell’installatore fino al saldo completo. Le firme equivalgono a firma digitale.
        </div>
      </div>
      <div class="print-only" id="printArea"></div>
    </div>
  </section>

  <!-- INTERVENTI -->
  <section id="iv">
    <div class="card">
      <h3>Interventi</h3>
      <p class="hint">Dopo la conferma del preventivo, potrai creare un intervento dedicato.</p>
    </div>
  </section>

  <!-- IMPOSTAZIONI -->
  <section id="st">
    <div class="card">
      <h3>Impostazioni</h3>
      <div class="row2">
        <div><label>Telefono intestazione</label><input id="st-phone" value="+39 351 796 9013"></div>
        <div><label>Termini personalizzati</label><textarea id="st-terms" placeholder="Scrivi qui i tuoi termini..."></textarea></div>
      </div>
      <label>Logo (JPG/PNG)</label>
      <input id="st-logo" type="file" accept="image/jpeg,image/png">
      <div class="btns" style="margin-top:8px">
        <button class="btn primary" id="st-save">Salva impostazioni</button>
        <button class="btn danger" id="st-reset">Ripristina</button>
      </div>
    </div>
  </section>
</main>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));}
const qs=(s,e=document)=>e.querySelector(s),qsa=(s,e=document)=>[...e.querySelectorAll(s)];
const fmt=n=>(Math.round((+n||0)*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const today=()=>{const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10)};
const S={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};

qsa('.tab').forEach(b=>b.addEventListener('click',()=>{qsa('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');const id=b.dataset.tab;qsa('main>section').forEach(s=>s.classList.toggle('active',s.id===id));}));

function loadBrand(){const phone=S.get('phone','+39 351 796 9013');const terms=S.get('terms','');const logo=S.get('logo',null);qs('#hdrTel').textContent='Tel. '+phone;qs('#st-phone').value=phone;qs('#st-terms').value=terms;if(logo){qs('#appLogo').src=logo;}else{qs('#appLogo').removeAttribute('src');}}
qs('#st-logo').addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;if(!/^image\/(jpeg|png)$/.test(f.type)){alert('Carica JPG/PNG');return;}const rd=new FileReader();rd.onload=ev=>{S.set('logo',ev.target.result);loadBrand();alert('Logo aggiornato ✅');};rd.readAsDataURL(f);});
qs('#st-save').onclick=()=>{S.set('phone',qs('#st-phone').value.trim()||'+39 351 796 9013');S.set('terms',qs('#st-terms').value);loadBrand();alert('Impostazioni salvate ✅');};
qs('#st-reset').onclick=()=>{['phone','terms','logo'].forEach(S.del);loadBrand();};

function addRow(d='',q=1,p=0){const tr=document.createElement('tr');tr.innerHTML=`<td><input class="d" value="${d}"></td><td><input class="q" type="number" value="${q}"></td><td><input class="p" type="number" value="${p}"></td><td class="no-print"><button class="btn danger x">×</button></td>`;qs('#pv-rows').appendChild(tr);tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',calc));tr.querySelector('.x').onclick=()=>{tr.remove();calc()};}
qs('#row-add').onclick=()=>addRow();qs('#row-clr').onclick=()=>{qs('#pv-rows').innerHTML='';calc();};

function rows(){return qsa('#pv-rows tr').map(tr=>({d:qs('.d',tr).value,q:+qs('.q',tr).value||0,p:+qs('.p',tr).value||0}));}
function calc(){const r=rows();const mat=r.reduce((s,v)=>s+v.q*v.p,0);const mo=(+qs('#mo-qty').value||0)*(+qs('#mo-rate').value||0);const tot=mat+mo;qs('#k-mat').textContent=fmt(mat);qs('#k-mo').textContent=fmt(mo);qs('#k-imp').textContent=fmt(tot);qs('#k-tot').textContent=fmt(tot);qs('#pv-tot').value=fmt(tot);const acp=(+qs('#pv-acp').value||0)/100;let ace=qs('#pv-ace-auto').checked?tot*acp:(+qs('#pv-ace').value||0);ace=Math.min(ace,tot);qs('#pv-ace').value=ace.toFixed(2);qs('#pv-bal').value=(tot-ace).toFixed(2);save();}
['#mo-qty','#mo-rate','#pv-acp','#pv-ace','#pv-ace-auto'].forEach(sel=>qs(sel).addEventListener('input',calc));

function nextNum(){let v=+(localStorage.getItem('pvCounter')||0);v++;localStorage.setItem('pvCounter',v);return'PV-'+String(v).padStart(4,'0');}
function newPV(){qs('#pv-num').value=nextNum();qs('#pv-date').value=today();const d=new Date(qs('#pv-date').value);d.setDate(d.getDate()+30);qs('#pv-exp').value=d.toISOString().slice(0,10);['#pv-cli','#pv-con','#pv-obj'].forEach(sel=>qs(sel).value='');qs('#pv-rows').innerHTML='';addRow();calc();}
qs('#pv-new').onclick=newPV;

function getDoc(){return{num:qs('#pv-num').value,date:qs('#pv-date').
