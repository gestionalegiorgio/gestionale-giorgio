<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Giorgio elettricista e antennista</title>

<!-- Colore barra / app -->
<meta name="theme-color" content="#0A2E5C">

<!-- Favicon (puoi lasciare questa o metterne una tua in data URL) -->
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/w8AAusB9QqP9x8AAAAASUVORK5CYII=">

<style>
  :root{--brand:#0A2E5C;--accent:#F7931E}
  body{margin:0;font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0a223d;background:#f6f8fb}
  header{background:var(--brand);color:#fff;padding:14px 16px}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .note{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
  .ok{display:inline-block;background:var(--accent);color:#fff;padding:6px 10px;border-radius:10px;margin-top:10px}
  .muted{color:#64748b}
</style>
</head>
<body>

<header>
  <h1>Giorgio ‚Äî Elettricista &amp; Antennista</h1>
  <div class="muted">PWA installabile ¬∑ offline ¬∑ stampa</div>
</header>

<div class="wrap">
  <div class="note">
    <strong>‚öôÔ∏è File unico, PWA auto-configurata</strong><br>
    Questo <em>index.html</em> crea da solo <b>manifest</b> e <b>service worker</b>. Puoi gi√† attivare GitHub Pages e installare l‚Äôapp.<br><br>
    <b>Per usare il tuo gestionale:</b> incolla il tuo HTML completo nel blocco qui sotto (sostituisci il segnaposto).
    <div class="ok">Funziona anche offline</div>
  </div>

  <!-- APP: QUI IL TUO GESTIONALE  -->
  <div id="app" class="wrap" style="padding:24px 0">
    <!-- üîΩ Sostituisci tutto questo div con il TUO gestionale (Preventivi/Interventi ecc.) -->
    <p class="muted">Segnaposto app ‚Äî incolla qui il tuo gestionale per intero (HTML+CSS+JS in linea o con link esterni).</p>
  </div>
  <!-- /APP -->
</div>

<script>
/* =========================
   1) ICONS in Data URL
   Sostituisci ICON192/ICON512 con il TUO logo (JPG/PNG) in base64.
   Basta mettere:  const ICON192 = "data:image/jpeg;base64,.....";
   ========================= */
const ICON192 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABb2j/AAAAAAXNSR0IArs4c6QAAABxpRE9UAAAAAgAAAAAAAAAwAAAAKAAAADAAAABMAf5j2AAAAF0lEQVR42u3BMQEAAADCIPunNsYQAAAAAAAAAO4GQwAAAHf2k1wAAAAASUVORK5CYII=";
const ICON512 = ICON192; // puoi metterne uno migliore 512√ó512

/* =========================
   2) Manifest generato al volo (un solo file!)
   ========================= */
const manifest = {
  name: "Giorgio elettricista e antennista",
  short_name: "Gestionale Giorgio",
  description: "Preventivi & Interventi ‚Äî PWA offline.",
  start_url: "./",
  scope: "./",
  display: "standalone",
  theme_color: "#0A2E5C",
  background_color: "#0A2E5C",
  icons: [
    { src: ICON192, sizes: "192x192", type: ICON192.split(';')[0].split(':')[1] || "image/png" },
    { src: ICON512, sizes: "512x512", type: ICON512.split(';')[0].split(':')[1] || "image/png" }
  ]
};

// Crea <link rel="manifest"> con Blob (niente file esterni)
(function injectManifest(){
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
  const url  = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = url;
  document.head.appendChild(link);
})();

/* =========================
   3) Service Worker iniettato da stringa (offline ready)
   Strategia: network-first con fallback alla cache + caching dinamico.
   ========================= */
const swCode = `
  const CACHE = 'ggiorgio-v1';
  self.addEventListener('install', e => {
    e.waitUntil((async ()=>{
      const c = await caches.open(CACHE);
      try { await c.addAll(['./']); } catch(e){}
      self.skipWaiting();
    })());
  });
  self.addEventListener('activate', e => {
    e.waitUntil((async ()=>{
      const keys = await caches.keys();
      await Promise.all(keys.filter(k => k!==CACHE).map(k=>caches.delete(k)));
      self.clients.claim();
    })());
  });
  self.addEventListener('fetch', e => {
    const req = e.request;
    // ignoriamo chiamate di terze parti non GET
    if (req.method !== 'GET') { return; }
    e.respondWith((async ()=>{
      try {
        const net = await fetch(req);
        const cache = await caches.open(CACHE);
        cache.put(req, net.clone());
        return net;
      } catch(err) {
        const hit = await caches.match(req);
        return hit || caches.match('./');
      }
    })());
  });
`;

// Registra SW da Blob (nessun file esterno)
(function registerSW(){
  if (!('serviceWorker' in navigator)) return;
  const blob = new Blob([swCode], {type: 'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  window.addEventListener('load', () => navigator.serviceWorker.register(swUrl).catch(()=>{}));
})();
</script>

</body>
</html>          <input id="pv-q" placeholder="Cerca: numero, cliente, oggetto..." class="no-print">
        </div>
        <div class="body list" id="pv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Preventivo</strong>
          <div class="actions">
            <button class="btn" id="pv-new">Nuovo</button>
            <button class="btn" id="pv-dup">Duplica</button>
            <button class="btn primary" id="pv-save">Salva</button>
            <button class="btn danger" id="pv-del">Elimina</button>
            <button class="btn" id="pv-print">Stampa / PDF</button>
            <button class="btn" id="pv-share">Condividi</button>
          </div>
        </div>
        <div class="body">
          <form id="pv-form" onsubmit="return false;">
            <input type="hidden" id="pv-id">
            <div class="grid3">
              <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
              <div><label>Data</label><input type="date" id="pv-date"></div>
              <div><label>Scadenza</label><input type="date" id="pv-expire" title="Di default 30 giorni dalla data"></div>
            </div>
            <div class="grid2">
              <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
              <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
            </div>
            <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

            <div class="grid3">
              <div><label>Q.t√† manodopera</label><input id="pv-labQ" type="number" min="0" step="0.25" value="0"></div>
              <div><label>Unit√†</label><select id="pv-labU"><option value="ora">Ore</option><option value="giorno">Giorni</option></select></div>
              <div><label>Tariffa (‚Ç¨ / unit√†)</label><input id="pv-labP" type="number" min="0" step="0.01" value="0"></div>
            </div>

            <label style="margin-top:10px">Materiali / Servizi</label>
            <table id="pv-rows">
              <thead><tr><th>Descrizione</th><th style="width:90px">Q.t√†</th><th style="width:110px">Prezzo</th><th style="width:44px" class="no-print">√ó</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="actions no-print">
              <button class="btn" type="button" id="pv-add">+ Riga</button>
              <button class="btn" type="button" id="pv-clear">Svuota righe</button>
            </div>

            <div class="grid3">
              <div><label>Sconto %</label><input type="number" id="pv-sco" value="0" step="0.1"></div>
              <div><label>Maggiorazione %</label><input type="number" id="pv-mag" value="0" step="0.1"></div>
              <div><label>Totale</label><input id="pv-tot" readonly></div>
            </div>

            <div class="kpis">
              <div class="box"><div class="hint">Materiali</div><div id="pv-mat">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Manodopera</div><div id="pv-lab">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Imponibile (materiali + manodopera)</div><div id="pv-imp">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Totale</div><div id="pv-to">‚Ç¨ 0,00</div></div>
            </div>

            <div style="margin-top:12px" class="grid2">
              <div class="sigWrap">
                <div class="grid2" style="align-items:center">
                  <strong>Firma Cliente ‚úçÔ∏è</strong>
                  <div class="actions" style="justify-content:end">
                    <button class="btn" type="button" data-open="sigC">Apri</button>
                    <button class="btn" type="button" data-clear="sigC">Pulisci</button>
                    <button class="btn" type="button" data-close="sigC">Chiudi</button>
                  </div>
                </div>
                <canvas id="sigC" class="sigPad hidden"></canvas>
                <div class="hint" id="sigCstate">Non firmato</div>
              </div>
              <div class="sigWrap">
                <div class="grid2" style="align-items:center">
                  <strong>Firma Tecnico ‚úçÔ∏è</strong>
                  <div class="actions" style="justify-content:end">
                    <button class="btn" type="button" data-open="sigT">Apri</button>
                    <button class="btn" type="button" data-clear="sigT">Pulisci</button>
                    <button class="btn" type="button" data-close="sigT">Chiudi</button>
                  </div>
                </div>
                <canvas id="sigT" class="sigPad hidden"></canvas>
                <div class="hint" id="sigTstate">Non firmato</div>
              </div>
            </div>

            <div class="hint" style="margin-top:6px">
              Termini: validit√† preventivo 30 giorni salvo diversa indicazione. Prezzi al netto di urgenze/trasferte se non indicati.
              Materiali garantiti se specificati. Pagamento alla consegna salvo accordi scritti. Le firme equivalgono a firma digitale.
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== INTERVENTI ========== -->
  <section id="iv">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Interventi</strong>
          <div class="actions">
            <button class="btn" id="iv-exp">Esporta</button>
            <label class="btn"><input type="file" id="iv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body list" id="iv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Intervento</strong>
          <div class="actions">
            <button class="btn" id="iv-new">Nuovo</button>
            <button class="btn" id="iv-dup">Duplica</button>
            <button class="btn primary" id="iv-save">Salva</button>
            <button class="btn danger" id="iv-del">Elimina</button>
          </div>
        </div>
        <div class="body">
          <form id="iv-form" onsubmit="return false;">
            <input type="hidden" id="iv-id">
            <div class="grid3">
              <div><label>Numero</label><input id="iv-num" placeholder="INT-0001"></div>
              <div><label>Data</label><input type="date" id="iv-date"></div>
              <div><label>Stato</label><select id="iv-st"><option>Aperto</option><option>In corso</option><option>Chiuso</option></select></div>
            </div>
            <div class="grid2">
              <div><label>Cliente</label><input id="iv-cli" placeholder="Nome cliente"></div>
              <div><label>Contatto</label><input id="iv-con" placeholder="Telefono / Email"></div>
            </div>
            <label>Descrizione</label>
            <textarea id="iv-des" placeholder="Diagnosi, materiali usati, note..."></textarea>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== IMPOSTAZIONI ========== -->
  <section id="st">
    <div class="card">
      <div class="head"><strong>Impostazioni</strong></div>
      <div class="body">
        <div class="grid2">
          <div><label>Intestazione</label><input id="st-rag" value="Giorgio ‚Äî Elettricista & Antennista"></div>
          <div><label>Colore brand</label><input id="st-brand" value="#0A2E5C"></div>
        </div>
        <div class="grid2">
          <div><label>Telefono</label><input id="st-phone" value="+39 351 796 9013"></div>
          <div><label>Note di stampa</label><input id="st-note" placeholder="Indirizzo, orari, condizioni..."></div>
        </div>
        <label>Logo JPG/PNG</label>
        <input type="file" id="st-file" accept="image/jpeg,image/png">
        <div style="margin-top:8px"><img id="st-prev" class="logo" alt="Anteprima logo"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="st-save">Salva impostazioni</button>
          <button class="btn" id="st-reset">Ripristina colori/testi</button>
          <button class="btn danger" id="st-wipe">Cancella tutti i dati</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Foglio stampa -->
  <section class="print-hide" style="display:none"><div id="sheet" class="sheet"></div></section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
/* ===== Helpers & Storage ===== */
const qs=(s,e=document)=>e.querySelector(s), qsa=(s,e=document)=>[...e.querySelectorAll(s)];
const S={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};
const today=()=>new Date().toISOString().slice(0,10);
const fmt=n=>(Math.round(n*100)/100).toFixed(2).replace('.',',');
const num=v=>isNaN(parseFloat(v))?0:parseFloat(v);
const uuid=()=>crypto.randomUUID();

/* ===== Tabs ===== */
qsa('nav .tab').forEach(b=>b.addEventListener('click',()=>{
  qsa('nav .tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  qsa('main>section').forEach(s=>s.classList.toggle('active', s.id===b.dataset.tab));
}));

/* ===== Branding / Impostazioni ===== */
function initBrand(){
  const rag=S.get('rag','Giorgio ‚Äî Elettricista & Antennista');
  const brand=S.get('brand','#0A2E5C');
  const phone=S.get('phone','+39 351 796 9013');
  const note=S.get('note','');
  const logo=S.get('logo',null);
  qs('#ttl').textContent=rag;
  qs('#tel').textContent=phone?('Tel. '+phone):'';
  document.documentElement.style.setProperty('--brand',brand);
  qs('#st-rag').value=rag; qs('#st-brand').value=brand; qs('#st-phone').value=phone; qs('#st-note').value=note;
  if(logo){qs('#appLogo').src=logo; qs('#st-prev').src=logo;}
}
qs('#st-save').onclick=()=>{
  S.set('rag',qs('#st-rag').value.trim()||'Giorgio ‚Äî Elettricista & Antennista');
  S.set('brand',qs('#st-brand').value.trim()||'#0A2E5C');
  S.set('phone',qs('#st-phone').value.trim());
  S.set('note',qs('#st-note').value.trim());
  alert('Impostazioni salvate'); initBrand();
};
qs('#st-reset').onclick=()=>{S.del('rag');S.del('brand');S.del('phone');S.del('note');initBrand()};
qs('#st-wipe').onclick=()=>{if(confirm('Cancellare TUTTI i dati?')){localStorage.clear();location.reload()}};
qs('#st-file').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=ev=>{S.set('logo',ev.target.result); initBrand();}; rd.readAsDataURL(f);
};

/* ===== Preventivi ===== */
const getPV=()=>S.get('pv',[]), setPV=a=>S.set('pv',a);
function addRow(desc='',q=1,pr=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="d" value="${desc}"></td>
    <td><input type="number" class="q" step="0.01" value="${q}"></td>
    <td><input type="number" class="p" step="0.01" value="${pr}"></td>
    <td class="no-print"><button type="button" class="btn danger x">√ó</button></td>`;
  qs('#pv-rows tbody').appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>i.oninput=calc);
  tr.querySelector('.x').onclick=()=>{tr.remove();calc()};
}
function rows(){return[...qsa('#pv-rows tbody tr')].map(tr=>({d:tr.querySelector('.d').value.trim(),q:num(tr.querySelector('.q').value),p:num(tr.querySelector('.p').value)})).filter(r=>r.d||r.q||r.p)}
function calc(){
  const r=rows();
  const mat=r.reduce((s,v)=>s+v.q*v.p,0);
  const labQ=num(qs('#pv-labQ').value), labP=num(qs('#pv-labP').value);
  const lab = labQ*labP;
  const imponibile = mat + lab;
  const sPerc=num(qs('#pv-sco').value), mPerc=num(qs('#pv-mag').value);
  const sVal=imponibile*sPerc/100;
  const base=imponibile-sVal;
  const mVal=base*mPerc/100;
  const tot=base+mVal;
  qs('#pv-mat').textContent='‚Ç¨ '+fmt(mat);
  qs('#pv-lab').textContent='‚Ç¨ '+fmt(lab);
  qs('#pv-imp').textContent='‚Ç¨ '+fmt(imponibile);
  qs('#pv-to').textContent='‚Ç¨ '+fmt(tot);
  qs('#pv-tot').value='‚Ç¨ '+fmt(tot);
}
['#pv-labQ','#pv-labP','#pv-sco','#pv-mag'].forEach(sel=>qs(sel).addEventListener('input',calc));

function statusByExpiry(p){
  if(!p.scadenza) return 'nd';
  const t=new Date().setHours(0,0,0,0);
  const d=new Date(p.scadenza).setHours(0,0,0,0);
  const diff=(d-t)/86400000;
  if(diff<0) return 'over';
  if(diff<=7) return 'due7';
  return 'ok';
}
function renderPV(){
  const l=qs('#pv-list'); l.innerHTML='';
  const q=qs('#pv-q').value.trim().toLowerCase();
  const f=qs('#pv-filter').value;
  const arr=getPV().filter(p=>{
    const hit=!q || [p.numero,p.cliente,p.oggetto].join(' ').toLowerCase().includes(q);
    const st=statusByExpiry(p);
    const ok = f==='all' || f===st;
    return hit && ok;
  });
  if(!arr.length){l.innerHTML='<div class="hint">Nessun preventivo</div>'; return}
  arr.forEach(p=>{
    const st=statusByExpiry(p);
    const badge= st==='over'?'üü• scaduto':(st==='due7'?'üü® in scadenza':'üü©');
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`<div><strong>${p.numero}</strong><br><small>${p.data} ¬∑ ${p.cliente||'‚Äî'}</small></div><small>${p.scadenza||''} ¬∑ ${badge}</small>`;
    d.onclick=()=>fillPV(p.id); l.appendChild(d);
  });
}
qs('#pv-q').oninput=renderPV; qs('#pv-filter').onchange=renderPV;

function newPV(){
  qs('#pv-form').reset(); qs('#pv-id').value='';
  qs('#pv-rows tbody').innerHTML=''; addRow();
  const seq=S.get('pv_seq',0)+1; S.set('pv_seq',seq);
  qs('#pv-num').value='PV-'+String(seq).padStart(4,'0');
  qs('#pv-date').value=today();
  const d=new Date(); d.setDate(d.getDate()+30); qs('#pv-expire').value=d.toISOString().slice(0,10);
  calc();
}
function readPV(){
  return { id:qs('#pv-id').value||uuid(),
    numero:qs('#pv-num').value.trim(), data:qs('#pv-date').value, scadenza:qs('#pv-expire').value,
    cliente:qs('#pv-cli').value.trim(), contatto:qs('#pv-con').value.trim(), oggetto:qs('#pv-obj').value.trim(),
    labQ:num(qs('#pv-labQ').value), labU:qs('#pv-labU').value, labP:num(qs('#pv-labP').value),
    voci:rows(), sconto:num(qs('#pv-sco').value), maggiorazione:num(qs('#pv-mag').value),
    totale:num(qs('#pv-to').textContent.replace('‚Ç¨ ','').replace(',','.')),
    sigC:qs('#sigC').dataset.png||null, sigT:qs('#sigT').dataset.png||null
  };
}
function fillPV(id){
  const p=getPV().find(x=>x.id===id); if(!p) return;
  qs('#pv-id').value=p.id; qs('#pv-num').value=p.numero; qs('#pv-date').value=p.data;
  qs('#pv-expire').value=p.scadenza||''; qs('#pv-cli').value=p.cliente||''; qs('#pv-con').value=p.contatto||'';
  qs('#pv-obj').value=p.oggetto||''; qs('#pv-rows tbody').innerHTML='';
  (p.voci||[]).forEach(v=>addRow(v.d,v.q,v.p));
  qs('#pv-labQ').value=p.labQ??0; qs('#pv-labU').value=p.labU||'ora'; qs('#pv-labP').value=p.labP??0;
  qs('#pv-sco').value=p.sconto??0; qs('#pv-mag').value=p.maggiorazione??0;
  if(p.sigC){qs('#sigC').dataset.png=p.sigC; qs('#sigCstate').textContent='Presente';}
  else {qs('#sigC').dataset.png=''; qs('#sigCstate').textContent='Non firmato';}
  if(p.sigT){qs('#sigT').dataset.png=p.sigT; qs('#sigTstate').textContent='Presente';}
  else {qs('#sigT').dataset.png=''; qs('#sigTstate').textContent='Non firmato';}
  calc();
}
function savePV(){const r=readPV(); const arr=getPV(); const i=arr.findIndex(x=>x.id===r.id); if(i>=0) arr[i]=r; else arr.unshift(r); setPV(arr); renderPV(); fillPV(r.id); alert('Preventivo salvato ‚úÖ');}
            <button class="btn" id="pv-print">Stampa / PDF</button>
            <button class="btn" id="pv-share">Condividi</button>
          </div>
        </div>
        <div class="body">
          <form id="pv-form">
            <input type="hidden" id="pv-id">
            <div class="grid3">
              <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
              <div><label>Data</label><input type="date" id="pv-date"></div>
              <div><label>Scadenza</label><input type="date" id="pv-expire" title="Calcolata automaticamente (30 giorni), modificabile"></div>
            </div>
            <div class="grid2">
              <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
              <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
            </div>
            <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

            <div class="grid3">
              <div>
                <label>Q.t√† manodopera</label>
                <input id="pv-labQ" type="number" min="0" step="0.25" value="0">
              </div>
              <div>
                <label>Unit√†</label>
                <select id="pv-labU">
                  <option value="ora">Ore</option>
                  <option value="giorno">Giorni</option>
                </select>
              </div>
              <div>
                <label>Tariffa (‚Ç¨ / unit√†)</label>
                <input id="pv-labP" type="number" min="0" step="0.01" value="0">
              </div>
            </div>

            <label style="margin-top:10px">Materiali / Servizi</label>
            <table id="pv-rows">
              <thead><tr><th>Descrizione</th><th style="width:90px">Q.t√†</th><th style="width:110px">Prezzo</th><th style="width:44px" class="no-print">√ó</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="actions no-print">
              <button class="btn" type="button" id="pv-add">+ Riga</button>
              <button class="btn" type="button" id="pv-clear">Svuota righe</button>
            </div>

            <div class="grid3">
              <div><label>Sconto %</label><input type="number" id="pv-sco" value="0" step="0.1"></div>
              <div><label>Maggiorazione %</label><input type="number" id="pv-mag" value="0" step="0.1"></div>
              <div><label>Totale</label><input id="pv-tot" readonly></div>
            </div>

            <div class="kpis">
              <div class="box"><div class="hint">Materiali</div><div id="pv-mat">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Manodopera</div><div id="pv-lab">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Imponibile (materiali + manodopera)</div><div id="pv-imp">‚Ç¨ 0,00</div></div>
              <div class="box"><div class="hint">Totale</div><div id="pv-to">‚Ç¨ 0,00</div></div>
            </div>

            <div style="margin-top:12px" class="grid2">
              <div class="sigWrap">
                <div class="grid2" style="align-items:center">
                  <strong>Firma Cliente ‚úçÔ∏è</strong>
                  <div class="actions" style="justify-content:end">
                    <button class="btn" type="button" data-open="sigC">Apri</button>
                    <button class="btn" type="button" data-clear="sigC">Pulisci</button>
                    <button class="btn" type="button" data-close="sigC">Chiudi</button>
                  </div>
                </div>
                <canvas id="sigC" class="sigPad" hidden></canvas>
                <div class="hint" id="sigCstate">Non firmato</div>
              </div>
              <div class="sigWrap">
                <div class="grid2" style="align-items:center">
                  <strong>Firma Tecnico ‚úçÔ∏è</strong>
                  <div class="actions" style="justify-content:end">
                    <button class="btn" type="button" data-open="sigT">Apri</button>
                    <button class="btn" type="button" data-clear="sigT">Pulisci</button>
                    <button class="btn" type="button" data-close="sigT">Chiudi</button>
                  </div>
                </div>
                <canvas id="sigT" class="sigPad" hidden></canvas>
                <div class="hint" id="sigTstate">Non firmato</div>
              </div>
            </div>

            <div class="hint" style="margin-top:6px">
              Termini: validit√† preventivo 30 giorni (salvo diversa indicazione). Prezzi al netto di eventuali accessi o urgenze. Materiali garantiti se indicati. Pagamento alla consegna salvo accordi scritti. Le firme sopra riportate equivalgono a firma digitale ai sensi di legge.
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- INTERVENTI -->
  <section id="iv">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Interventi</strong>
          <div class="actions">
            <button class="btn" id="iv-exp">Esporta</button>
            <label class="btn"><input type="file" id="iv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body list" id="iv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Intervento</strong>
          <div class="actions">
            <button class="btn" id="iv-new">Nuovo</button>
            <button class="btn" id="iv-dup">Duplica</button>
            <button class="btn primary" id="iv-save">Salva</button>
            <button class="btn danger" id="iv-del">Elimina</button>
          </div>
        </div>
        <div class="body">
          <form id="iv-form">
            <input type="hidden" id="iv-id">
            <div class="grid3">
              <div><label>Numero</label><input id="iv-num" placeholder="INT-0001"></div>
              <div><label>Data</label><input type="date" id="iv-date"></div>
              <div><label>Stato</label><select id="iv-st"><option>Aperto</option><option>In corso</option><option>Chiuso</option></select></div>
            </div>
            <div class="grid2">
              <div><label>Cliente</label><input id="iv-cli" placeholder="Nome cliente"></div>
              <div><label>Contatto</label><input id="iv-con" placeholder="Telefono / Email"></div>
            </div>
            <label>Descrizione</label>
            <textarea id="iv-des" placeholder="Diagnosi, materiali usati, note..."></textarea>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- IMPOSTAZIONI -->
  <section id="st">
    <div class="card">
      <div class="head"><strong>Impostazioni</strong></div>
      <div class="body">
        <div class="grid2">
          <div><label>Intestazione</label><input id="st-rag" value="Giorgio ‚Äî Elettricista & Antennista"></div>
          <div><label>Colore brand</label><input id="st-brand" value="#0A2E5C"></div>
        </div>
        <div class="grid2">
          <div><label>Telefono</label><input id="st-phone" value="+39 351 796 9013"></div>
          <div><label>Note di stampa</label><input id="st-note" placeholder="Indirizzo, orari, condizioni..."></div>
        </div>
        <label>Logo JPG/PNG</label>
        <input type="file" id="st-file" accept="image/jpeg,image/png">
        <div style="margin-top:8px"><img id="st-prev" class="logo" alt="Anteprima logo"></div>
        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="st-save">Salva impostazioni</button>
          <button class="btn" id="st-reset">Ripristina colori/testi</button>
          <button class="btn danger" id="st-wipe">Cancella tutti i dati</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STAMPA -->
  <section class="print-only" style="display:none"><div id="sheet" class="sheet"></div></section>
</main>

<script>
// Helpers & Storage
const qs=(s,e=document)=>e.querySelector(s), qsa=(s,e=document)=>[...e.querySelectorAll(s)];
const S={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};
const today=()=>new Date().toISOString().slice(0,10);
const fmt=n=>(Math.round(n*100)/100).toFixed(2).replace('.',',');
const num=v=>isNaN(parseFloat(v))?0:parseFloat(v);
const uuid=()=>crypto.randomUUID();

// Tabs
qsa('nav .tab').forEach(b=>b.addEventListener('click',()=>{
  qsa('nav .tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); qsa('main>section').forEach(s=>s.style.display=s.id===b.dataset.tab?'block':'none');
}));
qsa('main>section').forEach((s,i)=>s.style.display=i? 'none':'block');

// Brand
function initBrand(){
  const rag=S.get('rag','Giorgio ‚Äî Elettricista & Antennista');
  const brand=S.get('brand','#0A2E5C');
  const phone=S.get('phone','+39 351 796 9013');
  const note=S.get('note','');
  const logo=S.get('logo',null);
  qs('#ttl').textContent=rag;
  qs('#tel').textContent=phone?('Tel. '+phone):'';
  qs('#st-rag').value=rag; qs('#st-brand').value=brand; qs('#st-phone').value=phone; qs('#st-note').value=note;
  document.documentElement.style.setProperty('--brand',brand);
  if(logo){qs('#appLogo').src=logo; qs('#st-prev').src=logo;}
}
qs('#st-save').onclick=()=>{
  S.set('rag',qs('#st-rag').value.trim()||'Giorgio ‚Äî Elettricista & Antennista');
  S.set('brand',qs('#st-brand').value.trim()||'#0A2E5C');
  S.set('phone',qs('#st-phone').value.trim());
  S.set('note',qs('#st-note').value.trim());
  alert('Impostazioni salvate'); initBrand();
};
qs('#st-reset').onclick=()=>{S.del('rag');S.del('brand');S.del('phone');S.del('note');initBrand()};
qs('#st-wipe').onclick=()=>{if(confirm('Cancellare TUTTI i dati?')){localStorage.clear();location.reload()}};
qs('#st-file').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=ev=>{S.set('logo',ev.target.result);initBrand();}; rd.readAsDataURL(f);
};

// Preventivi data
const getPV=()=>S.get('pv',[]), setPV=arr=>S.set('pv',arr);

// Rows
function addRow(desc='',q=1,pr=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="d" value="${desc}"></td>
  <td><input type="number" class="q" step="0.01" value="${q}"></td>
  <td><input type="number" class="p" step="0.01" value="${pr}"></td>
  <td class="no-print"><button type="button" class="btn danger x">√ó</button></td>`;
  qs('#pv-rows tbody').appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>i.oninput=calc);
  tr.querySelector('.x').onclick=()=>{tr.remove();calc()};
}
qs('#pv-add').onclick=()=>addRow();
qs('#pv-clear').onclick=()=>{qs('#pv-rows tbody').innerHTML='';calc()};

// Totals
function rows(){return[...qsa('#pv-rows tbody tr')].map(tr=>({d:tr.querySelector('.d').value.trim(),q:num(tr.querySelector('.q').value),p:num(tr.querySelector('.p').value)})).filter(r=>r.d||r.q||r.p)}
function calc(){
  const r=rows();
  const mat=r.reduce((s,v)=>s+v.q*v.p,0);
  const labQ=num(qs('#pv-labQ').value), labP=num(qs('#pv-labP').value);
  const lab = labQ*labP;
  const imponibile = mat + lab;
  const sPerc=num(qs('#pv-sco').value), mPerc=num(qs('#pv-mag').value);
  const sVal=imponibile*sPerc/100;
  const base=imponibile-sVal;
  const mVal=base*mPerc/100;
  const tot=base+mVal;
  qs('#pv-mat').textContent='‚Ç¨ '+fmt(mat);
  qs('#pv-lab').textContent='‚Ç¨ '+fmt(lab);
  qs('#pv-imp').textContent='‚Ç¨ '+fmt(imponibile);
  qs('#pv-to').textContent='‚Ç¨ '+fmt(tot);
  qs('#pv-tot').value='‚Ç¨ '+fmt(tot);
}
['#pv-labQ','#pv-labP','#pv-sco','#pv-mag'].forEach(sel=>qs(sel).addEventListener('input',calc));
qs('#pv-labU').onchange=()=>calc();

// New / numbering / expiry
function autoNum(prefix,list){const n=((list[0]?.seq||0)+1);return {seq:n,code:`${prefix}-${String(n).padStart(4,'0')}`};}
function newPV(){
  qs('#pv-form').reset(); qs('#pv-id').value='';
  qs('#pv-rows tbody').innerHTML=''; addRow();
  qs('#pv-date').value=today();
  // auto number & expiry
  const arr=getPV(); const seq = S.get('pv_seq',0)+1; S.set('pv_seq',seq);
  qs('#pv-num').value='PV-'+String(seq).padStart(4,'0');
  const d=new Date(); d.setDate(d.getDate()+30); qs('#pv-expire').value=d.toISOString().slice(0,10);
  calc();
}
function readPV(){
  return { id:qs('#pv-id').value||uuid(),
    numero:qs('#pv-num').value.trim(), data:qs('#pv-date').value, scadenza:qs('#pv-expire').value,
    cliente:qs('#pv-cli').value.trim(), contatto:qs('#pv-con').value.trim(), oggetto:qs('#pv-obj').value.trim(),
    labQ:num(qs('#pv-labQ').value), labU:qs('#pv-labU').value, labP:num(qs('#pv-labP').value),
    voci:rows(), sconto:num(qs('#pv-sco').value), maggiorazione:num(qs('#pv-mag').value),
    totale:num(qs('#pv-to').textContent.replace('‚Ç¨ ','').replace(',','.')),
    sigC:qs('#sigC').dataset.png||null, sigT:qs('#sigT').dataset.png||null
  };
}
function fillPV(id){
  const p=getPV().find(x=>x.id===id); if(!p) return;
  qs('#pv-id').value=p.id; qs('#pv-num').value=p.numero; qs('#pv-date').value=p.data;
  qs('#pv-expire').value=p.scadenza||''; qs('#pv-cli').value=p.cliente||''; qs('#pv-con').value=p.contatto||'';
  qs('#pv-obj').value=p.oggetto||''; qs('#pv-rows tbody').innerHTML='';
  (p.voci||[]).forEach(v=>addRow(v.d,v.q,v.p));
  qs('#pv-labQ').value=p.labQ??0; qs('#pv-labU').value=p.labU||'ora'; qs('#pv-labP').value=p.labP??0;
  qs('#pv-sco').value=p.sconto??0; qs('#pv-mag').value=p.maggiorazione??0;
  // firme
  if(p.sigC){qs('#sigC').dataset.png=p.sigC;qs('#sigCstate').textContent='Presente';}
  else {qs('#sigC').dataset.png='';qs('#sigCstate').textContent='Non firmato';}
  if(p.sigT){qs('#sigT').dataset.png=p.sigT;qs('#sigTstate').textContent='Presente';}
  else {qs('#sigT').dataset.png='';qs('#sigTstate').textContent='Non firmato';}
  calc();
}
function savePV(){ const r=readPV(); const arr=getPV(); const i=arr.findIndex(x=>x.id===r.id); if(i>=0) arr[i]=r; else arr.unshift(r); setPV(arr); renderPV(); fillPV(r.id); alert('Salvato ‚úÖ'); }
function dupPV(){ const r=readPV(); r.id=uuid(); r.numero=r.numero+'-copy'; const arr=getPV(); arr.unshift(r); setPV(arr); renderPV(); fillPV(r.id); }
function delPV(){ const id=qs('#pv-id').value; if(!id) return; if(!confirm('Eliminare questo preventivo?')) return; const arr=getPV().filter(x=>x.id!==id); setPV(arr); renderPV(); arr.length?fillPV(arr[0].id):newPV(); }

function statusByExpiry(p){
  if(!p.scadenza) return 'nd';
  const t=new Date().setHours(0,0,0,0);
  const d=new Date(p.scadenza).setHours(0,0,0,0);
  const diff=(d-t)/86400000;
  if(diff<0) return 'over';
  if(diff<=7) return 'due7';
  return 'ok';
}
function renderPV(){
  const l=qs('#pv-list'); l.innerHTML='';
  const q=qs('#pv-q').value.trim().toLowerCase();
  const f=qs('#pv-filter').value;
  const arr=getPV().filter(p=>{
    const hit=!q || [p.numero,p.cliente,p.og    e.respondWith((async ()=>{
      try {
        const net = await fetch(req);
        const cache = await caches.open(CACHE);
        cache.put(req, net.clone());
        return net;
      } catch(err) {
        const hit = await caches.match(req);
        return hit || caches.match('./');
      }
    })());
  });
`;

// Registra SW da Blob (nessun file esterno)
(function registerSW(){
  if (!('serviceWorker' in navigator)) return;
  const blob = new Blob([swCode], {type: 'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  window.addEventListener('load', () => navigator.serviceWorker.register(swUrl).catch(()=>{}));
})();
</script>

</body>
</html>
