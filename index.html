<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Giorgio — Elettricista & Antennista</title>
<meta name="theme-color" content="#0A2E5C">
<style>
:root{--brand:#0A2E5C;--accent:#F7931E;--bg:#f6f8fb;--card:#fff;--line:#e6e8ef;--muted:#64748b}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a}

/* Header + Tabs */
header{position:sticky;top:0;z-index:20;background:var(--brand);color:#fff;padding:10px 14px;display:flex;gap:12px;align-items:center}
.logo{width:46px;height:46px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#fff}
h1{margin:0;font-size:18px}
header small{opacity:.9}
nav{position:sticky;top:66px;z-index:19;display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bg)}
.tab{padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Layout */
main{padding:12px;max-width:1100px;margin:0 auto}
main>section{display:none}
main>section.active{display:block}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.card>.head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.card>.body{padding:12px}
.split{display:grid;gap:12px;grid-template-columns:330px 1fr}
@media(max-width:930px){.split{grid-template-columns:1fr}}
.list{max-height:62vh;overflow:auto;display:flex;flex-direction:column}
.row{padding:10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:8px;cursor:pointer}
.row:hover{background:#f9fafb}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.grid3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
label{display:block;margin:8px 0 6px;font-weight:600}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{min-height:110px}
.btn{padding:9px 13px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.danger{color:#ef4444;border-color:#ef4444;background:#fff}
.actions{display:flex;gap:8px;flex-wrap:wrap}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid var(--line);padding:8px}
th{background:#f8fafc;text-align:left}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.badge.warn{border-color:#f59e0b;color:#b45309;background:#fffbeb}
.badge.danger{border-color:#ef4444;color:#991b1b;background:#fef2f2}
.note{font-size:12px;color:var(--muted)}
canvas[data-signature]{touch-action:none;-ms-touch-action:none}
.sig-box{background:#fff;width:100%;border-radius:14px;padding:10px}
.sig-box canvas{width:100%;height:260px;border:2px dashed #e5e7eb;border-radius:10px}

/* Stampa */
@media print{
  header,nav,.no-print{display:none!important}
  .printSheet{display:block!important;width:210mm;min-height:297mm;padding:16mm;margin:0 auto;color:#000}
  .ph{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .ph img{width:55px;height:55px;border-radius:50%;border:2px solid #000;object-fit:cover}
  .pt{font-weight:700;font-size:18px}
  .pm{font-size:12px;opacity:.8}
  .terms{font-size:11px;margin-top:8px}
  table,th,td{border:1px solid #000}
  .sign-row{display:flex;justify-content:flex-end;gap:24px;margin-top:16px}
  .sign{width:220px;text-align:center}
  .sign img{width:100%;max-height:90px;object-fit:contain;border:1px solid #000;padding:6px;background:#fff}
  .sign .cap{margin-top:6px;font-size:12px}
}
</style>
</head>
<body>
<header>
  <img id="appLogo" class="logo" alt="Logo">
  <div>
    <h1 id="ttl">Giorgio — Elettricista & Antennista</h1>
    <small id="tel">Tel. +39 351 796 9013</small> ·
    <small>v33 — Preventivi · Interventi · Impostazioni</small>
  </div>
</header>

<nav>
  <button class="tab active" data-tab="pv">Preventivi</button>
  <button class="tab" data-tab="iv">Interventi</button>
  <button class="tab" data-tab="st">Impostazioni</button>
</nav>

<main>
  <!-- PREVENTIVI -->
  <section id="pv" class="active">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Preventivi</strong>
          <div class="actions">
            <select id="pv-filter" class="btn">
              <option value="all">Tutti (scadenza)</option>
              <option value="due">In scadenza (7 giorni)</option>
              <option value="expired">Scaduti</option>
            </select>
            <button class="btn" id="pv-exp">Esporta</button>
            <label class="btn"><input type="file" id="pv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body">
          <input id="pv-search" placeholder="Cerca: numero, cliente, oggetto…">
        </div>
        <div class="body list" id="pv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Preventivo</strong>
          <div class="actions">
            <button class="btn" id="pv-new">Nuovo</button>
            <button class="btn" id="pv-dup">Duplica</button>
            <button class="btn primary" id="pv-save">Salva</button>
            <button class="btn" id="pv-to-iv">Crea intervento</button>
            <button class="btn danger" id="pv-del">Elimina</button>
            <button class="btn" id="pv-print">Stampa / PDF</button>
            <button class="btn" id="pv-share">Condividi</button>
          </div>
        </div>
        <div class="body" id="pv-form">
          <input type="hidden" id="pv-id">
          <div class="grid3">
            <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
            <div><label>Data</label><input type="date" id="pv-date"></div>
            <div><label>Scadenza</label><input type="date" id="pv-expdate"></div>
          </div>

          <div class="grid3">
            <div>
              <label>Unità manodopera</label>
              <select id="pv-lab-unit"><option value="h">Oraria</option><option value="d">Giornaliera</option></select>
            </div>
            <div><label>Q.tà manodopera</label><input type="number" id="pv-lab-qty" step="0.25" value="0" inputmode="decimal"></div>
            <div><label>Tariffa (€ / unità)</label><input type="number" id="pv-lab-rate" step="0.01" value="0" inputmode="decimal"></div>
          </div>

          <div class="grid2">
            <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
            <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
          </div>
          <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

          <label>Materiali / Servizi</label>
          <table id="pv-rows">
            <thead><tr><th>Descrizione</th><th style="width:92px">Q.tà</th><th style="width:120px">Prezzo</th><th style="width:46px">×</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="actions">
            <button class="btn" id="pv-add">+ Riga</button>
            <button class="btn" id="pv-clear">Svuota righe</button>
          </div>

          <div class="grid3">
            <div><label>Sconto %</label><input type="number" id="pv-sco" step="0.1" value="0" inputmode="decimal"></div>
            <div><label>Maggiorazione %</label><input type="number" id="pv-mag" step="0.1" value="0" inputmode="decimal"></div>
            <div><label>Totale</label><input id="pv-tot" readonly></div>
          </div>

          <div class="grid3">
            <div class="card"><div class="body"><div class="note">Materiali</div><div id="pv-mat">€ 0,00</div></div></div>
            <div class="card"><div class="body"><div class="note">Manodopera</div><div id="pv-lab">€ 0,00</div></div></div>
            <div class="card"><div class="body"><div class="note">Imponibile (materiali + manodopera)</div><div id="pv-imp">€ 0,00</div></div></div>
          </div>

          <div class="grid3">
            <div><label>Acconto %</label><input type="number" id="pv-dep-perc" step="1" value="50"></div>
            <div><label>Acconto €</label><input id="pv-dep-amt" readonly></div>
            <div><label>Saldo €</label><input id="pv-balance-amt" readonly></div>
          </div>

          <!-- FIRMA CLIENTE -->
          <div data-signature-wrap style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>Firma Cliente ✍️</strong>
              <span data-sig-badge class="badge">Non firmato</span>
            </div>
            <div class="sig-box" style="display:none">
              <canvas data-signature></canvas>
            </div>
            <div class="actions" style="margin-top:6px">
              <button class="btn" data-sig-open>Apri</button>
              <button class="btn" data-sig-clear>Pulisci</button>
              <button class="btn" data-sig-close>Chiudi</button>
            </div>
            <input type="hidden" name="firma_cliente" data-sig-data>
          </div>

          <!-- FIRMA TECNICO -->
          <div data-signature-wrap style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <strong>Firma Tecnico ✍️</strong>
              <span data-sig-badge class="badge">Non firmato</span>
            </div>
            <div class="sig-box" style="display:none">
              <canvas data-signature></canvas>
            </div>
            <div class="actions" style="margin-top:6px">
              <button class="btn" data-sig-open>Apri</button>
              <button class="btn" data-sig-clear>Pulisci</button>
              <button class="btn" data-sig-close>Chiudi</button>
            </div>
            <input type="hidden" name="firma_tecnico" data-sig-data>
          </div>

          <div class="note" id="pv-terms" style="margin-top:8px">
            Pagamento: acconto del 50% all’accettazione del preventivo e saldo al termine dei lavori.
            Il materiale fornito rimane di proprietà dell’installatore fino al saldo completo.
            Validità preventivo 30 giorni salvo accordi diversi. Eventuali varianti saranno concordate a parte.
            Le firme equivalgono a firma digitale.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- INTERVENTI -->
  <section id="iv">
    <div class="split">
      <div class="card">
        <div class="head">
          <strong>Elenco Interventi</strong>
          <div class="actions">
            <button class="btn" id="iv-exp">Esporta</button>
            <label class="btn"><input type="file" id="iv-imp" accept="application/json" style="display:none">Importa</label>
          </div>
        </div>
        <div class="body list" id="iv-list"></div>
      </div>

      <div class="card">
        <div class="head">
          <strong>Scheda Intervento</strong>
          <div class="actions">
            <button class="btn" id="iv-new">Nuovo</button>
            <button class="btn" id="iv-dup">Duplica</button>
            <button class="btn primary" id="iv-save">Salva</button>
            <button class="btn danger" id="iv-del">Elimina</button>
          </div>
        </div>
        <div class="body">
          <input type="hidden" id="iv-id">
          <div class="grid3">
            <div><label>Numero</label><input id="iv-num" placeholder="INT-0001"></div>
            <div><label>Data</label><input type="date" id="iv-date"></div>
            <div><label>Stato</label><select id="iv-st"><option>Aperto</option><option>In corso</option><option>Chiuso</option></select></div>
          </div>
          <div class="grid2">
            <div><label>Cliente</label><input id="iv-cli" placeholder="Nome cliente"></div>
            <div><label>Contatto</label><input id="iv-con" placeholder="Telefono / Email"></div>
          </div>
          <label>Descrizione</label>
          <textarea id="iv-des" placeholder="Diagnosi, materiali usati, note…"></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- IMPOSTAZIONI -->
  <section id="st">
    <div class="card">
      <div class="head"><strong>Impostazioni</strong></div>
      <div class="body">
        <div class="grid2">
          <div><label>Intestazione</label><input id="st-rag" value="Giorgio — Elettricista & Antennista"></div>
          <div><label>Colore brand</label><input id="st-brand" value="#0A2E5C"></div>
        </div>
        <div class="grid2">
          <div><label>Telefono</label><input id="st-phone" value="+39 351 796 9013"></div>
          <div><label>Note di stampa</label><input id="st-note" placeholder="Indirizzo, orari, condizioni…"></div>
        </div>
        <label>Logo JPG/PNG</label>
        <input type="file" id="st-file" accept="image/png,image/jpeg">
        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="st-save">Salva impostazioni</button>
          <button class="btn" id="st-reset">Ripristina predefiniti</button>
          <button class="btn danger" id="st-wipe">Cancella tutti i dati</button>
          <button class="btn" id="st-backup">Esporta impostazioni</button>
          <label class="btn"><input type="file" id="st-restore" accept="application/json" style="display:none">Importa impostazioni</label>
        </div>
      </div>
    </div>
  </section>

  <!-- PRINT -->
  <section id="print" class="no-print" style="display:none">
    <div id="sheet" class="printSheet"></div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const S={get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:k=>localStorage.removeItem(k)};
const today=()=>new Date().toISOString().slice(0,10);
const uuid=()=> (crypto && crypto.randomUUID ? crypto.randomUUID() : 'id-'+Date.now()+'-'+Math.random().toString(16).slice(2));
const num=v=>isNaN(parseFloat(v))?0:parseFloat(v);
const fmtEur=n=>'€ '+(Math.round(n*100)/100).toFixed(2).replace('.',',');

/* ===== Tabs ===== */
function bindTabs(){
  $$('nav .tab').forEach(b=>b.addEventListener('click',()=>{
    $$('nav .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    $$('main>section').forEach(s=>s.classList.toggle('active', s.id===b.dataset.tab));
  }));
}

/* ===== Logo: compress + fallback ===== */
function compressImageFile(file, maxW=400, maxH=400, quality=0.85){
  return new Promise((resolve, reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{
      const img=new Image();
      img.onload=()=>{
        let {width,height}=img;
        const r=Math.min(maxW/width,maxH/height,1);
        const w=Math.round(width*r), h=Math.round(height*r);
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',quality));
      };
      img.onerror=reject; img.src=fr.result;
    };
    fr.onerror=reject; fr.readAsDataURL(file);
  });
}
function setAppLogo(src){
  const el=$('#appLogo'); if(!el) return;
  if(!src){ el.src='icona-192.png'; return; }
  const test=new Image();
  test.onload=()=>{ el.src=src; };
  test.onerror=()=>{ el.src='icona-192.png'; };
  test.src=src;
}

/* ===== Brand/Impostazioni ===== */
function initBrand(){
  const rag=S.get('rag','Giorgio — Elettricista & Antennista');
  const brand=S.get('brand','#0A2E5C');
  const phone=S.get('phone','+39 351 796 9013');
  const logo=S.get('logo',null);
  $('#ttl').textContent=rag;
  $('#tel').textContent=phone?('Tel. '+phone):'';
  document.documentElement.style.setProperty('--brand',brand);
  setAppLogo(logo);
  $('#st-rag').value=rag; $('#st-brand').value=brand; $('#st-phone').value=phone; $('#st-note').value=S.get('note','');
}
function bindSettings(){
  $('#st-save').onclick=()=>{
    S.set('rag',$('#st-rag').value.trim()||'Giorgio — Elettricista & Antennista');
    S.set('brand',$('#st-brand').value.trim()||'#0A2E5C');
    S.set('phone',$('#st-phone').value.trim());
    S.set('note',$('#st-note').value.trim());
    initBrand(); alert('Impostazioni salvate ✅');
  };
  $('#st-reset').onclick=()=>{['rag','brand','phone','note','logo'].forEach(S.del); initBrand();};
  $('#st-file').onchange= async e=>{
    const f=e.target.files[0]; if(!f) return;
    if(!/^image\/(png|jpeg|jpg)$/.test(f.type)){ alert('Carica PNG o JPG'); return; }
    try{
      const dataUrl=await compressImageFile(f,400,400,0.85);
      S.set('logo',dataUrl); initBrand(); alert('Logo aggiornato ✅ (ottimizzato)');
    }catch(err){ console.error(err); alert('Non riesco a salvare il logo. Prova un file più piccolo.'); }
  };
  $('#st-wipe').onclick=()=>{ if(confirm('Cancellare TUTTI i dati?')){ localStorage.clear(); location.reload(); } };
  $('#st-backup').onclick=()=>{
    const data={ rag:S.get('rag',''), brand:S.get('brand',''), phone:S.get('phone',''), note:S.get('note',''), logo:S.get('logo',null) };
    const a=document.createElement('a');
    a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data));
    a.download='impostazioni_giorgio.json'; a.click();
  };
  $('#st-restore').onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      try{
        const o=JSON.parse(ev.target.result);
        ['rag','brand','phone','note','logo'].forEach(k=>{ if(k in o) S.set(k,o[k]); });
        initBrand(); alert('Impostazioni importate ✅');
      }catch{ alert('File impostazioni non valido'); }
    };
    r.readAsText(f);
  };
}

/* ===== Store ===== */
const getPV=()=>S.get('pv',[]), setPV=a=>S.set('pv',a);
const getIV=()=>S.get('iv',[]), setIV=a=>S.set('iv',a);

/* ===== Preventivi: righe & calcoli ===== */
function addRow(desc='',q=1,pr=0){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class="d" value="${desc}"></td>
  <td><input type="number" class="q" step="0.01" inputmode="decimal" value="${q}"></td>
  <td><input type="number" class="p" step="0.01" inputmode="decimal" value="${pr}"></td>
  <td><button class="btn danger x" type="button">×</button></td>`;
  $('#pv-rows tbody').appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',calc));
  tr.querySelector('.x').onclick=()=>{tr.remove();calc(); ensureAtLeastOneRow();};
}
function rows(){return [...$('#pv-rows tbody').querySelectorAll('tr')].map(tr=>({
  desc:tr.querySelector('.d').value.trim(), qty:num(tr.querySelector('.q').value), price:num(tr.querySelector('.p').value)
})).filter(r=>r.desc||r.qty||r.price)}
function ensureAtLeastOneRow(){
  const tb=$('#pv-rows tbody'); if(!tb) return;
  if(tb.children.length===0) addRow();
}
function calc(){
  const r=rows();
  const materiali=r.reduce((s,v)=>s+v.qty*v.price,0);

  const labQty=num($('#pv-lab-qty').value);
  const labRate=num($('#pv-lab-rate').value);
  const manodopera=labQty*labRate;

  const imponibile=materiali+manodopera;

  const sPerc=num($('#pv-sco').value), mPerc=num($('#pv-mag').value);
  const afterDiscount=imponibile - (imponibile*sPerc/100);
  const totale=afterDiscount + (afterDiscount*mPerc/100);

  $('#pv-mat').textContent=fmtEur(materiali);
  $('#pv-lab').textContent=fmtEur(manodopera);
  $('#pv-imp').textContent=fmtEur(imponibile);

  const sVal=imponibile*sPerc/100, mVal=afterDiscount*mPerc/100;
  $('#pv-sc') && ($('#pv-sc').textContent=fmtEur(sVal));
  $('#pv-mg') && ($('#pv-mg').textContent=fmtEur(mVal));
  $('#pv-to').textContent=fmtEur(totale);
  $('#pv-tot').value=fmtEur(totale);

  // Acconto/Saldo
  const depPerc = Math.max(0, Math.min(100, num($('#pv-dep-perc').value||'0')));
  const depAmt  = (totale * depPerc / 100);
  const balance = Math.max(0, totale - depAmt);
  $('#pv-dep-amt').value = fmtEur(depAmt);
  $('#pv-balance-amt').value = fmtEur(balance);
}
function bindCalcInputs(){
  $('#pv-add').onclick=()=>{addRow();};
  $('#pv-clear').onclick=()=>{$('#pv-rows tbody').innerHTML=''; calc(); ensureAtLeastOneRow();};
  ['pv-lab-qty','pv-lab-rate','pv-sco','pv-mag','pv-dep-perc'].forEach(id=>$('#'+id).addEventListener('input',calc));
}

/* ===== Preventivi CRUD ===== */
function nextPVNumber(){
  const arr=getPV(); let n=0;
  arr.forEach(p=>{ const m=(p.numero||'').match(/PV-(\d+)/i); if(m) n=Math.max(n,parseInt(m[1],10)); });
  const ctr=parseInt(localStorage.getItem('pvCounter')||'0',10);
  n=Math.max(n,ctr)+1; localStorage.setItem('pvCounter',String(n));
  return 'PV-'+String(n).padStart(4,'0');
}
function clearSignatures(){
  document.querySelectorAll('[data-signature-wrap]').forEach(w=>{
    const canvas=w.querySelector('canvas[data-signature]');
    const hid=w.querySelector('[data-sig-data]');
    const badge=w.querySelector('[data-sig-badge]');
    if(canvas?.getContext){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }
    if(hid) hid.value='';
    if(badge){ badge.textContent='Non firmato'; badge.className='badge'; badge.style.cssText=''; }
  });
}
function newPV(){
  $('#pv-id').value='';
  $('#pv-num').value=nextPVNumber();
  $('#pv-date').value=today();
  const d=new Date(); d.setDate(d.getDate()+30);
  $('#pv-expdate').value=d.toISOString().slice(0,10);

  ['pv-cli','pv-con','pv-obj'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });

  $('#pv-lab-unit').value='h'; $('#pv-lab-qty').value=0; $('#pv-lab-rate').value=0;
  $('#pv-sco').value=0; $('#pv-mag').value=0;
  $('#pv-dep-perc').value=50;

  $('#pv-rows tbody').innerHTML=''; addRow();
  clearSignatures();
  calc(); ensureAtLeastOneRow();
}
function readPV(){
  return {
    id:$('#pv-id').value||uuid(),
    numero:$('#pv-num').value.trim(),
    data:$('#pv-date').value,
    scadenza:$('#pv-expdate').value,
    unita:$('#pv-lab-unit').value,
    labqty:num($('#pv-lab-qty').value),
    labrate:num($('#pv-lab-rate').value),
    cliente:$('#pv-cli').value.trim(),
    contatto:$('#pv-con').value.trim(),
    oggetto:$('#pv-obj').value.trim(),
    voci:rows(),
    sconto:num($('#pv-sco').value),
    maggiorazione:num($('#pv-mag').value),
    depPerc:num($('#pv-dep-perc').value),
    totale:(($('#pv-tot').value||'').replace('€','').replace(',','.').trim())||'0',
    sigC: document.querySelector('[name="firma_cliente"]')?.value || '',
    sigT: document.querySelector('[name="firma_tecnico"]')?.value || ''
  };
}
function fillPV(id){
  const p=getPV().find(x=>x.id===id); if(!p) return;
  $('#pv-id').value=p.id; $('#pv-num').value=p.numero; $('#pv-date').value=p.data; $('#pv-expdate').value=p.scadenza||'';
  $('#pv-lab-unit').value=p.unita||'h'; $('#pv-lab-qty').value=p.labqty??0; $('#pv-lab-rate').value=p.labrate??0;
  $('#pv-cli').value=p.cliente||''; $('#pv-con').value=p.contatto||''; $('#pv-obj').value=p.oggetto||'';
  $('#pv-rows tbody').innerHTML=''; (p.voci||[]).forEach(v=>addRow(v.desc,v.qty,v.price));
  $('#pv-sco').value=p.sconto??0; $('#pv-mag').value=p.maggiorazione??0; $('#pv-dep-perc').value=p.depPerc??50;

  // firme salvate
  document.querySelector('[name="firma_cliente"]').value = p.sigC||'';
  document.querySelector('[name="firma_tecnico"]').value = p.sigT||'';
  // badge
  document.querySelectorAll('[data-signature-wrap]').forEach(w=>{
    const hid=w.querySelector('[data-sig-data]');
    const badge=w.querySelector('[data-sig-badge]');
    if(hid?.value){ badge.textContent='Firmato'; badge.className='badge'; badge.style.borderColor='#10b981'; badge.style.color='#065f46'; badge.style.background='#ecfdf5'; }
    else{ badge.textContent='Non firmato'; badge.className='badge'; badge.style.cssText=''; }
  });

  calc(); ensureAtLeastOneRow();
}
function savePV(){
  const numFld=$('#pv-num'); if(numFld && !numFld.value.trim()) numFld.value=nextPVNumber();
  const r=readPV(); const arr=getPV(); const i=arr.findIndex(x=>x.id===r.id);
  if(i>=0) arr[i]=r; else arr.unshift(r);
  setPV(arr); renderPV(); fillPV(r.id); alert('Preventivo salvato ✅'); ensureAtLeastOneRow();
}
function dupPV(){ const r=readPV(); r.id=uuid(); r.numero=r.numero+'-copy'; const arr=getPV(); arr.unshift(r); setPV(arr); renderPV(); fillPV(r.id); ensureAtLeastOneRow(); }
function delPV(){ const id=$('#pv-id').value; if(!id) return; if(!confirm('Eliminare questo preventivo?')) return; const arr=getPV().filter(x=>x.id!==id); setPV(arr); renderPV(); arr.length?fillPV(arr[0].id):newPV(); }

/* ===== Lista + filtri scadenza ===== */
function statusBadge(p){
  const now=new Date(); const exp=new Date(p.scadenza||p.data);
  const diff=Math.ceil((exp-now)/(1000*60*60*24));
  if(diff<0) return '<span class="badge danger">Scaduto</span>';
  if(diff<=7) return '<span class="badge warn">In scadenza</span>';
  return '';
}
function renderPV(){
  const l=$('#pv-list'); if(!l) return; l.innerHTML='';
  const q=($('#pv-search').value||'').toLowerCase();
  const f=$('#pv-filter').value;
  getPV().filter(p=>{
    const expDays=Math.ceil((new Date(p.scadenza||p.data)-new Date())/(1000*60*60*24));
    if(f==='due' && !(expDays>=0 && expDays<=7)) return false;
    if(f==='expired' && !(expDays<0)) return false;
    if(q && !(p.numero+p.cliente+p.oggetto).toLowerCase().includes(q)) return false;
    return true;
  }).forEach(p=>{
    const d=document.createElement('div'); d.className='row';
    d.innerHTML=`<div><strong>${p.numero}</strong><br><small>${p.data} · ${p.cliente||'—'}</small></div><div>${statusBadge(p)}</div>`;
    d.onclick=()=>fillPV(p.id); l.appendChild(d);
  });
}
function bindPVImpExp(){
  $('#pv-exp').onclick=()=>{const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(getPV())); a.download='preventivi.json'; a.click();};
  $('#pv-imp').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{try{setPV(JSON.parse(ev.target.result)); renderPV(); alert('Import ok')}catch{alert('File non valido')}}; r.readAsText(f);};
  $('#pv-search').addEventListener('input',renderPV);
  $('#pv-filter').addEventListener('change',renderPV);
}

/* ===== Interventi ===== */
function newIV(){ $('#iv-id').value=''; $('#iv-num').value='INT-'+String(getIV().length+1).padStart(4,'0'); $('#iv-date').value=today(); $('#iv-st').value='Aperto'; $('#iv-cli').value=''; $('#iv-con').value=''; $('#iv-des').value=''; }
function readIV(){ return { id:$('#iv-id').value||uuid(), numero:$('#iv-num').value.trim(), data:$('#iv-date').value, stato:$('#iv-st').value, cliente:$('#iv-cli').value.trim(), contatto:$('#iv-con').value.trim(), descrizione:$('#iv-des').value.trim() }; }
function fillIV(id){ const p=getIV().find(x=>x.id===id); if(!p) return; $('#iv-id').value=p.id; $('#iv-num').value=p.numero; $('#iv-date').value=p.data; $('#iv-st').value=p.stato; $('#iv-cli').value=p.cliente||''; $('#iv-con').value=p.contatto||''; $('#iv-des').value=p.descrizione||''; }
function renderIV(){ const l=$('#iv-list'); if(!l) return; l.innerHTML=''; getIV().forEach(p=>{ const d=document.createElement('div'); d.className='row'; d.innerHTML=`<div><strong>${p.numero}</strong><br><small>${p.data} · ${p.cliente||'—'}</small></div><small>${p.stato}</small>`; d.onclick=()=>fillIV(p.id); l.appendChild(d); }); }
function saveIV(){ const r=readIV(); const arr=getIV(); const i=arr.findIndex(x=>x.id===r.id); if(i>=0) arr[i]=r; else arr.unshift(r); setIV(arr); renderIV(); fillIV(r.id); alert('Intervento salvato ✅'); }
function dupIV(){ const r=readIV(); r.id=uuid(); r.numero=r.numero+'-copy'; const arr=getIV(); arr.unshift(r); setIV(arr); renderIV(); fillIV(r.id); }
function delIV(){ const id=$('#iv-id').value; if(!id) return; if(!confirm('Eliminare questo intervento?')) return; const arr=getIV().filter(x=>x.id!==id); setIV(arr); renderIV(); arr.length?fillIV(arr[0].id):newIV(); }
function bindIVImpExp(){
  $('#iv-exp').onclick=()=>{const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(getIV())); a.download='interventi.json'; a.click();};
  $('#iv-imp').onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{try{setIV(JSON.parse(ev.target.result)); renderIV();}catch{alert('File non valido')}}; r.readAsText(f);};
}

/* ===== Firme (inline) ===== */
function initSignPads(){
  document.querySelectorAll('[data-signature-wrap]').forEach(wrap=>{
    const box=wrap.querySelector('.sig-box');
    const canvas=wrap.querySelector('canvas[data-signature]');
    const hidden=wrap.querySelector('[data-sig-data]');
    const badge=wrap.querySelector('[data-sig-badge]');
    const openBtn=wrap.querySelector('[data-sig-open]');
    const clearBtn=wrap.querySelector('[data-sig-clear]');
    const closeBtn=wrap.querySelector('[data-sig-close]');
    const ctx=canvas.getContext('2d',{willReadFrequently:true});

    let drawing=false;
    let dpr=Math.max(1,window.devicePixelRatio||1);

    function sizeCanvas(){
      const cssH=canvas.clientHeight||260;
      const cssW=canvas.clientWidth||wrap.clientWidth||600;
      canvas.width=Math.round(cssW*dpr);
      canvas.height=Math.round(cssH*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#0A2E5C';
    }
    function openPad(){ box.style.display='block'; sizeCanvas(); }
    function closePad(){
      const blank=document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height;
      if(canvas.toDataURL()!==blank.toDataURL()){
        hidden.value=canvas.toDataURL('image/png');
        if(badge){ badge.textContent='Firmato'; badge.className='badge'; badge.style.borderColor='#10b981'; badge.style.color='#065f46'; badge.style.background='#ecfdf5'; }
      }
      box.style.display='none';
    }
    function clearPad(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      hidden.value='';
      if(badge){ badge.textContent='Non firmato'; badge.className='badge'; badge.style.cssText=''; }
    }
    function pos(e){ const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
    const start=e=>{ e.preventDefault(); drawing=true; const {x,y}=pos(e); ctx.beginPath(); ctx.moveTo(x,y); };
    const move =e=>{ if(!drawing) return; e.preventDefault(); const {x,y}=pos(e); ctx.lineTo(x,y); ctx.stroke(); };
    const end  =e=>{ if(!drawing) return; e.preventDefault(); drawing=false; };

    canvas.addEventListener('pointerdown',start,{passive:false});
    canvas.addEventListener('pointermove',move,{passive:false});
    window.addEventListener('pointerup',end,{passive:false});
    canvas.addEventListener('touchstart',start,{passive:false});
    canvas.addEventListener('touchmove', move,{passive:false});
    window.addEventListener('touchend', end,{passive:false});
    canvas.addEventListener('mousedown',start,{passive:false});
    canvas.addEventListener('mousemove',move,{passive:false});
    window.addEventListener('mouseup',end,{passive:false});

    openBtn?.addEventListener('click',openPad);
    clearBtn?.addEventListener('click',clearPad);
    closeBtn?.addEventListener('click',closePad);

    new ResizeObserver(()=>{ if(box.style.display!=='none') sizeCanvas(); }).observe(canvas);
  });
}

/* ===== Print & Share ===== */
function renderPrint(rec){
  const sheet=$('#sheet');
  const logo=S.get('logo',null)||'icona-192.png';
  const righe=(rec.voci||[]).map(v=>`<tr><td>${v.desc}</td><td>${v.qty}</td><td>€ ${(v.price).toFixed(2).replace('.',',')}</td><td>€ ${(v.qty*v.price).toFixed(2).replace('.',',')}</td></tr>`).join('');
  const mat=(rec.voci||[]).reduce((s,v)=>s+v.qty*v.price,0);
  const lab=(rec.labqty||0)*(rec.labrate||0);
  const imp=mat+lab;
  const sVal=imp*(rec.sconto||0)/100;
  const base=imp - sVal;
  const mVal=base*(rec.maggiorazione||0)/100;
  const tot=base + mVal;
  const depPerc = rec.depPerc||0;
  const depAmt  = tot * depPerc / 100;
  const balance = Math.max(0, tot - depAmt);

  const sigCliente=document.querySelector('[name="firma_cliente"]')?.value||'';
  const sigTecnico=document.querySelector('[name="firma_tecnico"]')?.value||'';

  const terms = $('#pv-terms').textContent.trim();

  sheet.innerHTML=`
    <div class="ph">
      <img src="${logo}" alt="logo">
      <div>
        <div class="pt">${S.get('rag','Giorgio — Elettricista & Antennista')}</div>
        <div class="pm">${S.get('phone','')}</div>
      </div>
    </div>
    <h3 style="margin:8px 0">PREVENTIVO ${rec.numero}</h3>
    <div class="pm">Data: ${rec.data} · Scadenza: ${rec.scadenza||''}</div>
    <div class="pm">Cliente: ${rec.cliente||'—'} · Contatto: ${rec.contatto||'—'}</div>
    <div class="pm">Oggetto: ${rec.oggetto||'—'}</div>

    <table style="margin-top:8px;width:100%;border-collapse:collapse">
      <thead><tr><th>Descrizione</th><th>Q.tà</th><th>Prezzo</th><th>Totale</th></tr></thead>
      <tbody>${righe||'<tr><td colspan="4">—</td></tr>'}</tbody>
    </table>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px">
      <div class="card"><div class="body"><div class="note">Materiali</div>${fmtEur(mat)}</div></div>
      <div class="card"><div class="body"><div class="note">Manodopera (${rec.unita==='d'?'Giorni':'Ore'})</div>${fmtEur(lab)}</div></div>
      <div class="card"><div class="body"><div class="note">Sconto</div>${fmtEur(sVal)}</div></div>
      <div class="card"><div class="body"><div class="note">Totale</div>${fmtEur(tot)}</div></div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
      <div class="card"><div class="body"><div class="note">Acconto (${depPerc}%)</div>${fmtEur(depAmt)}</div></div>
      <div class="card"><div class="body"><div class="note">Saldo alla consegna</div>${fmtEur(balance)}</div></div>
      <div class="card"><div class="body"><div class="note">Imponibile (materiali + manodopera)</div>${fmtEur(imp)}</div></div>
    </div>

    <div class="sign-row">
      ${sigTecnico
        ? `<div class="sign"><img src="${sigTecnico}" alt="Firma Tecnico"><div class="cap">Firma Tecnico</div></div>`
        : `<div class="sign"><div style="height:90px;border-bottom:1px solid #000"></div><div class="cap">Firma Tecnico</div></div>`}
      ${sigCliente
        ? `<div class="sign"><img src="${sigCliente}" alt="Firma Cliente"><div class="cap">Firma Cliente</div></div>`
        : `<div class="sign"><div style="height:90px;border-bottom:1px solid #000"></div><div class="cap">Firma Cliente</div></div>`}
    </div>

    <div class="terms" style="margin-top:10px">${terms}</div>
  `;
}
function bindPrintShare(){
  $('#pv-print').onclick=()=>{ const rec=readPV(); renderPrint(rec); window.print(); };
  $('#pv-share').onclick=()=>{
    const r=readPV();
    const text=`Preventivo ${r.numero}
Data: ${r.data}  Scadenza: ${r.scadenza||'-'}
Cliente: ${r.cliente||'-'}  Contatto: ${r.contatto||'-'}
Oggetto: ${r.oggetto||'-'}
Totale: ${($('#pv-tot').value||'').trim()}
Acconto ${r.depPerc||0}%: ${$('#pv-dep-amt').value||'-'}  —  Saldo: ${$('#pv-balance-amt').value||'-'}
— Inviato da ${S.get('rag','Giorgio — Elettricista & Antennista')}`;
    if(navigator.share){ navigator.share({title:`Preventivo ${r.numero}`, text}).catch(()=>{}); }
    else{ navigator.clipboard.writeText(text); alert('Testo del preventivo copiato negli appunti ✅'); }
  };
}

/* ===== Preventivo -> Intervento ===== */
function buildDescriptionFromPV(p){
  const rows = (p.voci||[]).map(v=>`- ${v.desc} (x${v.qty} · € ${(v.price).toFixed(2)}) = € ${(v.qty*v.price).toFixed(2)}`).join('\n');
  const labUnit = p.unita === 'd' ? 'giorni' : 'ore';
  const hasLab  = (p.labqty||0) > 0 && (p.labrate||0) > 0;
  const labLine = hasLab ? `\nManodopera: ${p.labqty} ${labUnit} × € ${(p.labrate).toFixed(2)} = € ${(p.labqty*p.labrate).toFixed(2)}` : '';
  const tot = ($('#pv-tot').value||'').trim();
  return `Da preventivo ${p.numero} del ${p.data}
Oggetto: ${p.oggetto||'-'}

Materiali/servizi:
${rows || '-'}${labLine}

Totale preventivo: ${tot}`;
}
function pvToIV(){
  const r=readPV(); if(!r.numero){ alert('Salva prima il preventivo'); return; }
  const arr=getIV();
  const nuovoIV={ id:uuid(), numero:'INT-'+String(arr.length+1).padStart(4,'0'), data:today(), stato:'Aperto',
    cliente:r.cliente||'', contatto:r.contatto||'', descrizione:buildDescriptionFromPV(r) };
  arr.unshift(nuovoIV); setIV(arr); renderIV();
  $$('nav .tab').forEach(t=>t.classList.remove('active')); $('nav .tab[data-tab="iv"]').classList.add('active');
  $$('main>section').forEach(s=>s.classList.remove('active')); $('#iv').classList.add('active');
  fillIV(nuovoIV.id); alert('Intervento creato da preventivo ✅');
}

/* ===== Binds ===== */
function bindMainButtons(){
  $('#pv-new').onclick=newPV; $('#pv-save').onclick=savePV; $('#pv-del').onclick=delPV; $('#pv-dup').onclick=dupPV; $('#pv-to-iv').onclick=pvToIV;
  $('#iv-new').onclick=newIV; $('#iv-save').onclick=saveIV; $('#iv-del').onclick=delIV; $('#iv-dup').onclick=dupIV;
}

/* ===== Start ===== */
function start(){
  bindTabs();
  initBrand(); bindSettings();
  bindCalcInputs(); bindPVImpExp(); bindIVImpExp(); bindPrintShare(); bindMainButtons();
  renderPV(); renderIV();
  newPV(); newIV();
  initSignPads();
}
document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', start) : start();

/* (nessun service worker in v33 safe) */
</script>
</body>
</html>
