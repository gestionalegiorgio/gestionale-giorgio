<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestionale Giorgio — Preventivi & Interventi</title>
<meta name="theme-color" content="#0A2E5C">
<style>
  :root{--brand:#0A2E5C;--accent:#F59E0B;--bg:#f5f7fb;--card:#fff;--line:#e5e7eb;--muted:#64748b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827}
  header{position:sticky;top:0;z-index:5;background:var(--brand);color:#fff;padding:10px 14px;border-bottom:3px solid var(--accent)}
  header .row{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#fff}
  .title{display:flex;flex-direction:column}
  .title strong{font-size:18px}
  .tabs{display:flex;gap:8px;padding:10px;background:#eef2ff;border-bottom:1px solid var(--line)}
  .tab{border:1px solid #c7d2fe;background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
  .tab.active{background:#1b3e8b;color:#fff;border-color:#1b3e8b}
  main{padding:14px;max-width:980px;margin:0 auto}
  section{display:none}
  section.active{display:block}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px; padding:14px; margin-bottom:12px}
  label{display:block;margin:6px 2px;color:#334155;font-weight:600;font-size:13px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:90px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:800px){.row2,.row3{grid-template-columns:1fr}}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .btn{padding:9px 13px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:#1e66ff;color:#fff;border-color:#1e66ff}
  .btn.warn{background:#fff3bf;border-color:#fde68a}
  .btn.danger{color:#ef4444;border-color:#ef4444}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px}
  th{background:#f8fafc;text-align:left;font-size:13px;color:#334155}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  @media (max-width:800px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .box{background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:10px}
  .kpi .val{font-weight:800}
  .signwrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:800px){.signwrap{grid-template-columns:1fr}}
  .sign{border:2px dashed var(--line);border-radius:12px;padding:10px;background:#fff}
  .sign footer{display:flex;gap:6px;margin-top:6px;align-items:center}
  .status{margin-left:auto;color:var(--muted);font-size:12px}
  .hint{color:var(--muted);font-size:12px}
  .terms{font-size:13px;color:#111827}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#fff}
  .badge.red{background:#fee2e2;border-color:#fecaca}
  .badge.amber{background:#fef3c7;border-color:#fde68a}
  .badge.green{background:#dcfce7;border-color:#bbf7d0}
  .print-only{display:none}
  @media print{
    header,.tabs,.btns,.no-print{display:none!important}
    .print-only{display:block}
    body{background:#fff}
    .card{border:none}
    table,th,td{border:1px solid #000}
  }
</style>
</head>
<body>

<header>
  <div class="row">
    <img id="appLogo" class="logo" alt="Logo">
    <div class="title">
      <strong>Giorgio — Elettricista & Antennista</strong>
      <small id="hdrTel">Tel. +39 351 796 9013</small>
    </div>
  </div>
</header>

<nav class="tabs no-print">
  <button class="tab active" data-tab="pv">Preventivi</button>
  <button class="tab" data-tab="iv">Interventi</button>
  <button class="tab" data-tab="st">Impostazioni</button>
</nav>

<main>
  <!-- ===================== PREVENTIVI ===================== -->
  <section id="pv" class="active">
    <div class="card">
      <div class="btns">
        <button class="btn" id="pv-new" type="button">Nuovo</button>
        <button class="btn primary" id="pv-save" type="button">Salva</button>
        <button class="btn" id="pv-print" type="button">Stampa / PDF</button>
        <button class="btn warn" id="pv-share" type="button">Condividi</button>
        <button class="btn" id="pv-to-iv" type="button">Crea Intervento da Preventivo</button>
        <button class="btn" id="btn-refresh" type="button">Aggiorna cache</button>
        <button class="btn danger" id="btn-wipe" type="button">Svuota dati</button>
      </div>

      <div class="row3">
        <div><label>Numero</label><input id="pv-num" placeholder="PV-0001"></div>
        <div><label>Data</label><input id="pv-date" type="date"></div>
        <div><label>Scadenza</label><input id="pv-exp" type="date"></div>
      </div>
      <div class="row3">
        <div><label>Stato</label>
          <select id="pv-state">
            <option value="bozza">Bozza</option>
            <option value="inviato">Inviato</option>
            <option value="confermato">Confermato</option>
            <option value="chiuso">Chiuso</option>
          </select>
        </div>
        <div><label>Cliente</label><input id="pv-cli" placeholder="Nome cliente"></div>
        <div><label>Contatto</label><input id="pv-con" placeholder="Telefono / Email"></div>
      </div>
      <label>Oggetto</label><input id="pv-obj" placeholder="Oggetto del preventivo">

      <h3 style="margin:12px 2px 6px">Manodopera</h3>
      <div class="row3">
        <div>
          <label>Tipo</label>
          <select id="mo-type">
            <option value="ora">Oraria</option>
            <option value="giorno">Giornaliera</option>
          </select>
        </div>
        <div><label>Q.tà</label><input id="mo-qty" type="number" min="0" step="1" value="0"></div>
        <div><label>Tariffa (€/unità)</label><input id="mo-rate" type="number" min="0" step="0.01" value="0"></div>
      </div>

      <h3 style="margin:12px 2px 6px">Materiali / Servizi</h3>
      <table>
        <thead><tr><th>Descrizione</th><th style="width:110px">Q.tà</th><th style="width:140px">Prezzo</th><th style="width:44px" class="no-print">×</th></tr></thead>
        <tbody id="pv-rows"></tbody>
      </table>
      <div class="btns no-print">
        <button class="btn" id="row-add" type="button">+ Riga</button>
        <button class="btn" id="row-clr" type="button">Svuota righe</button>
      </div>

      <div class="row3">
        <div><label>Sconto %</label><input id="pv-disc" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Maggiorazione %</label><input id="pv-mark" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Totale</label><input id="pv-tot" readonly></div>
      </div>

      <div class="kpi">
        <div class="box"><div class="hint">Materiali</div><div class="val" id="k-mat">€ 0,00</div></div>
        <div class="box"><div class="hint">Manodopera</div><div class="val" id="k-mo">€ 0,00</div></div>
        <div class="box"><div class="hint">Imponibile (materiali + manodopera)</div><div class="val" id="k-imp">€ 0,00</div></div>
        <div class="box"><div class="hint">Totale</div><div class="val" id="k-tot">€ 0,00</div></div>
      </div>

      <div class="row3" style="margin-top:8px">
        <div><label>Acconto %</label><input id="pv-acp" type="number" min="0" max="100" value="50"></div>
        <div><label>Acconto €</label><input id="pv-ace" type="number" min="0" step="0.01" value="0"></div>
        <div><label>Saldo €</label><input id="pv-bal" type="number" min="0" step="0.01" value="0"></div>
      </div>

      <h3 style="margin:12px 2px 6px">Firme</h3>
      <div class="signwrap">
        <div class="sign" id="sg-cliente">
          <div class="hint"><strong>Firma Cliente</strong> — Apri per firmare</div>
          <canvas hidden></canvas>
          <footer>
            <button class="btn" data-act="open">Apri</button>
            <button class="btn" data-act="clear">Pulisci</button>
            <button class="btn" data-act="close">Chiudi</button>
            <span class="status">Non firmato</span>
          </footer>
        </div>
        <div class="sign" id="sg-tecnico">
          <div class="hint"><strong>Firma Tecnico</strong></div>
          <canvas hidden></canvas>
          <footer>
            <button class="btn" data-act="open">Apri</button>
            <button class="btn" data-act="clear">Pulisci</button>
            <button class="btn" data-act="close">Chiudi</button>
            <span class="status">Non firmato</span>
          </footer>
        </div>
      </div>

      <div class="card no-print" id="pv-list-card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Elenco Preventivi</h3>
        <div class="row2" style="margin-bottom:8px">
          <select id="pv-filter">
            <option value="all">Tutti</option>
            <option value="bozza">Bozze</option>
            <option value="inviato">Inviati</option>
            <option value="confermato">Confermati</option>
            <option value="chiuso">Chiusi</option>
            <option value="in_scadenza">In scadenza (7gg)</option>
            <option value="scaduto">Scaduti</option>
          </select>
          <input id="pv-search" placeholder="Cerca: numero, cliente, oggetto…">
        </div>
        <div id="pv-list" class="hint">Ancora nessun preventivo salvato.</div>
      </div>

      <div class="card">
        <div class="terms" id="terms">
          <strong>Termini:</strong> Pagamento <strong>50%</strong> all’accettazione del preventivo e <strong>50%</strong> a fine lavori.
          Il materiale resta di proprietà dell’installatore fino al saldo completo. Le firme equivalgono a firma digitale.
        </div>
      </div>

      <div class="print-only" id="printAreaPV"></div>
    </div>
  </section>

  <!-- ===================== INTERVENTI (COMPLETI) ===================== -->
  <section id="iv">
    <div class="card">
      <div class="btns">
        <button class="btn" id="iv-new" type="button">Nuovo</button>
        <button class="btn primary" id="iv-save" type="button">Salva</button>
        <button class="btn" id="iv-print" type="button">Stampa / PDF</button>
        <button class="btn warn" id="iv-share" type="button">Condividi</button>
      </div>

      <div class="row3">
        <div><label>Numero</label><input id="iv-num" placeholder="INT-0001"></div>
        <div><label>Data</label><input id="iv-date" type="date"></div>
        <div><label>Scadenza</label><input id="iv-exp" type="date"></div>
      </div>
      <div class="row3">
        <div><label>Stato</label>
          <select id="iv-state">
            <option value="aperto">Aperto</option>
            <option value="incorso">In corso</option>
            <option value="chiuso">Chiuso</option>
          </select>
        </div>
        <div><label>Cliente</label><input id="iv-cli" placeholder="Nome cliente"></div>
        <div><label>Contatto</label><input id="iv-con" placeholder="Telefono / Email"></div>
      </div>
      <label>Oggetto / Descrizione</label><input id="iv-obj" placeholder="Oggetto o breve descrizione">

      <h3 style="margin:12px 2px 6px">Manodopera</h3>
      <div class="row3">
        <div>
          <label>Tipo</label>
          <select id="ivmo-type">
            <option value="ora">Oraria</option>
            <option value="giorno">Giornaliera</option>
          </select>
        </div>
        <div><label>Q.tà</label><input id="ivmo-qty" type="number" min="0" step="1" value="0"></div>
        <div><label>Tariffa (€/unità)</label><input id="ivmo-rate" type="number" min="0" step="0.01" value="0"></div>
      </div>

      <h3 style="margin:12px 2px 6px">Materiali / Servizi</h3>
      <table>
        <thead><tr><th>Descrizione</th><th style="width:110px">Q.tà</th><th style="width:140px">Prezzo</th><th style="width:44px" class="no-print">×</th></tr></thead>
        <tbody id="iv-rows"></tbody>
      </table>
      <div class="btns no-print">
        <button class="btn" id="ivrow-add" type="button">+ Riga</button>
        <button class="btn" id="ivrow-clr" type="button">Svuota righe</button>
      </div>

      <div class="row3">
        <div><label>Sconto %</label><input id="iv-disc" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Maggiorazione %</label><input id="iv-mark" type="number" min="0" step="0.1" value="0"></div>
        <div><label>Totale</label><input id="iv-tot" readonly></div>
      </div>

      <div class="kpi">
        <div class="box"><div class="hint">Materiali</div><div class="val" id="ivk-mat">€ 0,00</div></div>
        <div class="box"><div class="hint">Manodopera</div><div class="val" id="ivk-mo">€ 0,00</div></div>
        <div class="box"><div class="hint">Imponibile (materiali + manodopera)</div><div class="val" id="ivk-imp">€ 0,00</div></div>
        <div class="box"><div class="hint">Totale</div><div class="val" id="ivk-tot">€ 0,00</div></div>
      </div>

      <h3 style="margin:12px 2px 6px">Firme</h3>
      <div class="signwrap">
        <div class="sign" id="ivsg-cliente">
          <div class="hint"><strong>Firma Cliente</strong> — Apri per firmare</div>
          <canvas hidden></canvas>
          <footer>
            <button class="btn" data-act="open">Apri</button>
            <button class="btn" data-act="clear">Pulisci</button>
            <button class="btn" data-act="close">Chiudi</button>
            <span class="status">Non firmato</span>
          </footer>
        </div>
        <div class="sign" id="ivsg-tecnico">
          <div class="hint"><strong>Firma Tecnico</strong></div>
          <canvas hidden></canvas>
          <footer>
            <button class="btn" data-act="open">Apri</button>
            <button class="btn" data-act="clear">Pulisci</button>
            <button class="btn" data-act="close">Chiudi</button>
            <span class="status">Non firmato</span>
          </footer>
        </div>
      </div>

      <div class="card no-print" id="iv-list-card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Elenco Interventi</h3>
        <div class="row2" style="margin-bottom:8px">
          <select id="iv-filter">
            <option value="all">Tutti</option>
            <option value="aperto">Aperti</option>
            <option value="incorso">In corso</option>
            <option value="chiuso">Chiusi</option>
          </select>
          <input id="iv-search" placeholder="Cerca: numero, cliente, oggetto…">
        </div>
        <div id="iv-list" class="hint">Ancora nessun intervento salvato.</div>
      </div>

      <div class="print-only" id="printAreaIV"></div>
    </div>
  </section>

  <!-- ===================== IMPOSTAZIONI ===================== -->
  <section id="st">
    <div class="card">
      <h3>Impostazioni</h3>
      <div class="row2">
        <div><label>Telefono intestazione</label><input id="st-phone" value="+39 351 796 9013"></div>
        <div><label>Termini personalizzati</label><textarea id="st-terms" placeholder="Scrivi qui i tuoi termini se vuoi sostituirli..."></textarea></div>
      </div>
      <label>Logo (JPG/PNG)</label>
      <input id="st-logo" type="file" accept="image/jpeg,image/png">
      <div class="btns" style="margin-top:8px">
        <button class="btn primary" id="st-save" type="button">Salva impostazioni</button>
        <button class="btn danger" id="st-reset" type="button">Ripristina predefiniti</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Bootstrap sicuro / delega eventi ===== */
(() => {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  function on(sel, type, handler, root=document){
    root.addEventListener(type, e=>{
      const t = e.target.closest(sel);
      if (t) handler(e, t);
    });
  }
  function safe(fn, name='init'){ try { fn(); } catch(err){ console.error(`[${name}]`, err); } }

  document.addEventListener('DOMContentLoaded', () => {
    safe(()=>{
      on('.tabs .tab','click',(_,btn)=>{
        $$('.tabs .tab').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        const id=btn.dataset.tab;
        $$('main>section').forEach(s=>s.classList.toggle('active', s.id===id));
      });
    }, 'tabs');

    // Preventivi
    safe(()=>{
      on('#pv-new','click', ()=> newPV());
      on('#pv-save','click',()=> pvSave());
      on('#pv-print','click',()=> pvPrint());
      on('#pv-share','click',()=> pvShare());
      on('#pv-to-iv','click',()=> pvToIV());
      on('#row-add','click',()=> addRow('#pv-rows'));
      on('#row-clr','click',()=>{ $('#pv-rows').innerHTML=''; calcPV(); });
      on('#pv-state','change',()=> saveDraftPV());
    }, 'pv-buttons');

    // Interventi
    safe(()=>{
      on('#iv-new','click', ()=> newIV());
      on('#iv-save','click',()=> ivSave());
      on('#iv-print','click',()=> ivPrint());
      on('#iv-share','click',()=> ivShare());
      on('#ivrow-add','click',()=> addRow('#iv-rows'));
      on('#ivrow-clr','click',()=>{ $('#iv-rows').innerHTML=''; calcIV(); });
      on('#iv-state','change',()=> {/* no draft persistenza separata */});
    }, 'iv-buttons');

    // Comune: cache & wipe
    safe(()=>{
      on('#btn-refresh','click', async ()=>{ 
        if(!confirm('Aggiornare la cache dell’app?')) return;
        try{
          if('caches' in window){
            const keys = await caches.keys();
            await Promise.all(keys.map(k=>caches.delete(k)));
          }
          if('serviceWorker' in navigator){
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r=>r.unregister()));
          }
        }catch(_){}
        location.reload();
      });
      on('#btn-wipe','click', ()=>{ 
        if(!confirm('Cancellare LOGO, impostazioni e bozze/elenchi dal dispositivo?')) return;
        localStorage.clear(); location.reload();
      });
    }, 'refresh+wipe');

    // Impostazioni
    safe(()=>{
      on('#st-save','click', ()=> saveSettings());
      on('#st-reset','click',()=> resetSettings());
      const inputLogo = $('#st-logo');
      if (inputLogo) inputLogo.addEventListener('change', e=> handleLogoFile(e));
    }, 'settings');

    safe(()=> boot(), 'boot');
    window.$=$; window.$$=$$; window.on=on;
  });
})();

/* ===== Utils / Storage ===== */
const qs = (s,e=document)=>e.querySelector(s), qsa=(s,e=document)=>[...e.querySelectorAll(s)];
const fmt = n => (Math.round((+n||0)*100)/100).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
const today = ()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10);};
const S = {get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)), del:(k)=>localStorage.removeItem(k)};

/* ===== Brand / Impostazioni ===== */
function loadBrand(){
  const phone = S.get('phone','+39 351 796 9013');
  const terms = S.get('terms','');
  const logo = S.get('logo',null);
  qs('#hdrTel').textContent = 'Tel. ' + phone;
  qs('#st-phone').value = phone;
  qs('#st-terms').value = terms;
  if(logo){ qs('#appLogo').src=logo; } else { qs('#appLogo').removeAttribute('src'); }
}
function handleLogoFile(e){
  const f=e.target.files?.[0]; if(!f) return;
  if(!/^image\/(jpeg|png)$/.test(f.type)) { alert('Carica JPG/PNG'); return; }
  const rd=new FileReader(); rd.onload=ev=>{ S.set('logo', ev.target.result); loadBrand(); alert('Logo aggiornato ✅'); }; rd.readAsDataURL(f);
}
function saveSettings(){
  S.set('phone', qs('#st-phone').value.trim()||'+39 351 796 9013');
  S.set('terms', qs('#st-terms').value);
  loadBrand();
  alert('Impostazioni salvate ✅');
}
function resetSettings(){ ['phone','terms','logo'].forEach(S.del); loadBrand(); }

/* ===== Righe comuni ===== */
function addRow(tbodySel, desc='',qty=1,price=0){
  const tb = qs(tbodySel);
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="d" placeholder="Descrizione" value="${desc}"></td>
    <td><input class="q" type="number" min="0" step="1" value="${qty}"></td>
    <td><input class="p" type="number" min="0" step="0.01" value="${price}"></td>
    <td class="no-print"><button class="btn danger x" type="button">×</button></td>`;
  tb.appendChild(tr);
  tr.querySelectorAll('input').forEach(i=>{
    i.addEventListener('input',()=>{
      if(tbodySel==='#pv-rows') calcPV(); else calcIV();
    },{passive:true});
  });
  tr.querySelector('.x').addEventListener('click',()=>{
    tr.remove();
    if(tbodySel==='#pv-rows') calcPV(); else calcIV();
  });
}

/* ===== Firma (factory) ===== */
function signature(boxSel){
  const box = qs(boxSel);
  const canvas = qs('canvas', box);
  const status = qs('.status', box);
  let ctx=null, drawing=false, ink=false;

  function ensure(){
    if (!canvas.hidden) return;
    canvas.hidden=false;
    const w = box.clientWidth - 20;
    canvas.width = Math.max(320, w);
    canvas.height = 190;
    ctx = canvas.getContext('2d',{willReadFrequently:true});
    ctx.lineWidth=2.6; ctx.lineCap='round'; ctx.strokeStyle='#0A2E5C';
  }
  function pos(e){
    const r=canvas.getBoundingClientRect();
    const t=e.touches?e.touches[0]:e;
    return {x:(t.clientX-r.left)*(canvas.width/r.width), y:(t.clientY-r.top)*(canvas.height/r.height)};
  }
  box.addEventListener('click',e=>{
    if(e.target.dataset.act==='open'){ ensure(); }
    if(e.target.dataset.act==='clear' && !canvas.hidden){ ctx.clearRect(0,0,canvas.width,canvas.height); ink=false; status.textContent='Non firmato'; saveDraftPV(); }
    if(e.target.dataset.act==='close'){ canvas.hidden=true; }
  });
  function start(e){ if(canvas.hidden) return; e.preventDefault(); drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
  function move(e){ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ink=true; e.preventDefault(); }
  function end(){ drawing=false; if(ink) status.textContent='Firmato'; saveDraftPV(); }
  ['pointerdown','touchstart','mousedown'].forEach(ev=>canvas.addEventListener(ev,start,{passive:false}));
  ['pointermove','touchmove','mousemove'].forEach(ev=>canvas.addEventListener(ev,move,{passive:false}));
  ['pointerup','touchend','mouseup','mouseleave','touchcancel'].forEach(ev=>canvas.addEventListener(ev,end,{passive:false}));

  return {
    data: ()=> canvas.hidden? '' : canvas.toDataURL('image/png'),
    load: (dataURL)=>{ if(!dataURL) return; ensure(); const img=new Image(); img.onload=()=>{ctx.drawImage(img,0,0); status.textContent='Firmato'; canvas.hidden=true;}; img.src=dataURL; },
    clear: ()=>{ if(!canvas.hidden){ ctx.clearRect(0,0,canvas.width,canvas.height); status.textContent='Non firmato'; } }
  }
}

/* ====== Preventivi (PV) ====== */
const sigCliPV = signature('#sg-cliente');
const sigTecPV = signature('#sg-tecnico');

function rowsPV(){
  return qsa('#pv-rows tr').map(tr=>({
    d: qs('.d',tr).value.trim(),
    q: +qs('.q',tr).value||0,
    p: +qs('.p',tr).value||0
  })).filter(r=>r.d||r.q||r.p);
}
function calcPV(){
  const r = rowsPV();
  const mat = r.reduce((s,v)=>s+v.q*v.p,0);
  const mo = (+qs('#mo-qty').value||0) * (+qs('#mo-rate').value||0);
  const disc = (+qs('#pv-disc').value||0)/100;
  const mark = (+qs('#pv-mark').value||0)/100;

  let matNet = mat;
  if (disc>0) matNet *= (1-disc);
  if (mark>0) matNet *= (1+mark);

  const impon = matNet + mo;
  const tot = impon;

  qs('#k-mat').textContent = fmt(matNet);
  qs('#k-mo').textContent  = fmt(mo);
  qs('#k-imp').textContent = fmt(impon);
  qs('#k-tot').textContent = fmt(tot);
  qs('#pv-tot').value = fmt(tot);

  const acp = (+qs('#pv-acp').value||0)/100;
  const acCalc = tot*acp;
  const acFix = (+qs('#pv-ace').value||0);
  const ac = Math.max(acCalc, acFix);
  qs('#pv-ace').value = (Math.round(ac*100)/100).toFixed(2);
  qs('#pv-bal').value = (Math.max(tot-ac,0)).toFixed(2);

  saveDraftPV();
}
['#mo-qty','#mo-rate','#pv-disc','#pv-mark','#pv-acp','#pv-ace'].forEach(sel=>document.addEventListener('input',e=>{
  if(e.target && e.target.matches(sel)) calcPV();
},{passive:true}));

function nextNumPV(){ const k='pvCounter'; let v=+(localStorage.getItem(k)||0); v++; localStorage.setItem(k, v); return 'PV-'+String(v).padStart(4,'0'); }
function getDocPV(){
  return {
    id: qs('#pv-id')?.value || crypto.randomUUID(),
    num:qs('#pv-num').value, date:qs('#pv-date').value, exp:qs('#pv-exp').value,
    state:qs('#pv-state').value,
    cli:qs('#pv-cli').value, con:qs('#pv-con').value, obj:qs('#pv-obj').value,
    moType:qs('#mo-type').value, moQty:+qs('#mo-qty').value||0, moRate:+qs('#mo-rate').value||0,
    rows:rowsPV(), disc:+qs('#pv-disc').value||0, mark:+qs('#pv-mark').value||0,
    acp:+qs('#pv-acp').value||0, ace:+qs('#pv-ace').value||0, bal:+qs('#pv-bal').value||0,
    k:{mat:qs('#k-mat').textContent, mo:qs('#k-mo').textContent, imp:qs('#k-imp').textContent, tot:qs('#k-tot').textContent},
    signCli:sigCliPV.data(), signTec:sigTecPV.data()
  };
}
function setDocPV(d){
  if(!d) return;
  qs('#pv-num').value=d.num||nextNumPV(); qs('#pv-date').value=d.date||today(); qs('#pv-exp').value=d.exp||today();
  qs('#pv-state').value=d.state||'bozza';
  qs('#pv-cli').value=d.cli||''; qs('#pv-con').value=d.con||''; qs('#pv-obj').value=d.obj||'';
  qs('#mo-type').value=d.moType||'ora'; qs('#mo-qty').value=d.moQty||0; qs('#mo-rate').value=d.moRate||0;
  qs('#pv-rows').innerHTML=''; (d.rows||[]).forEach(x=>addRow('#pv-rows',x.d,x.q,x.p)); if((d.rows||[]).length===0) addRow('#pv-rows');
  qs('#pv-disc').value=d.disc||0; qs('#pv-mark').value=d.mark||0;
  qs('#pv-acp').value=d.acp||50; qs('#pv-ace').value=d.ace||0; qs('#pv-bal').value=d.bal||0;
  if(d.signCli) sigCliPV.load(d.signCli); if(d.signTec) sigTecPV.load(d.signTec);
  calcPV();
}
function saveDraftPV(){ S.set('draftPV', getDocPV()); }

/* archivio PV */
function pvAll(){ return S.get('pvItems',[]); }
function pvPut(item){ const arr=pvAll(); const i=arr.findIndex(x=>x.id===item.id); if(i>=0) arr[i]=item; else arr.unshift(item); S.set('pvItems',arr); }
function isOverdue(exp){
  if(!exp) return false;
  const d=new Date(exp); const t=new Date(); d.setHours(0,0,0,0); t.setHours(0,0,0,0);
  return d < t;
}
function isDueSoon(exp){
  if(!exp) return false;
  const d=new Date(exp); const t=new Date(); d.setHours(0,0,0,0); t.setHours(0,0,0,0);
  const diff=(d-t)/(1000*3600*24);
  return diff>=0 && diff<=7;
}
function pvRender(){
  const list = pvAll();
  const q = (qs('#pv-search')?.value||'').trim().toLowerCase();
  const f = (qs('#pv-filter')?.value||'all');
  const filtered = list.filter(x=>{
    const hit = ( (x.num||'')+(x.cli||'')+(x.obj||'') ).toLowerCase().includes(q);
    let ok = hit;
    if(f==='in_scadenza') ok = ok && isDueSoon(x.exp);
    else if(f==='scaduto') ok = ok && isOverdue(x.exp);
    else if(f!=='all') ok = ok && (x.state===f);
    return ok;
  });
  const el = qs('#pv-list'); if(!el) return;
  el.innerHTML = filtered.length
    ? filtered.map(x=>{
        const b = isOverdue(x.exp) ? '<span class="badge red">Scaduto</span>'
                : isDueSoon(x.exp) ? '<span class="badge amber">In scadenza</span>'
                : x.state==='confermato' ? '<span class="badge green">Confermato</span>'
                : `<span class="badge">${x.state||'bozza'}</span>`;
        return `<div class="card" style="margin:6px 0; cursor:pointer" data-id="${x.id}">
          <div style="display:flex;gap:8px;align-items:center">
            <strong>${x.num}</strong>
            <span class="hint">• ${x.date} → ${x.exp}</span>
            <span class="hint">• ${x.cli||'-'}</span>
            <span style="margin-left:8px">${b}</span>
            <span class="hint" style="margin-left:auto">${x.k?.tot||''}</span>
          </div>
          <div class="hint">${x.obj||''}</div>
        </div>`;
      }).join('')
    : '<div class="hint">Nessun elemento.</div>';

  qsa('#pv-list .card').forEach(row=>{
    row.onclick = ()=>{
      const id = row.dataset.id;
      const item = pvAll().find(x=>x.id===id);
      if(item) setDocPV(item.data);
      alert('Preventivo caricato ✅');
    };
  });
}
['#pv-search','#pv-filter'].forEach(sel=>qs(sel)?.addEventListener('input',pvRender));

function newPV(){
  qs('#pv-num').value = nextNumPV();
  qs('#pv-date').value = today();
  const d = new Date(qs('#pv-date').value); d.setDate(d.getDate()+30); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  qs('#pv-exp').value = d.toISOString().slice(0,10);
  qs('#pv-state').value='bozza';
  ['#pv-cli','#pv-con','#pv-obj'].forEach(sel=>qs(sel).value='');
  qs('#mo-type').value='ora'; qs('#mo-qty').value=0; qs('#mo-rate').value=0;
  qs('#pv-disc').value=0; qs('#pv-mark').value=0;
  qs('#pv-acp').value=50; qs('#pv-ace').value=0; qs('#pv-bal').value=0;
  qs('#pv-rows').innerHTML=''; addRow('#pv-rows');
  sigCliPV.clear(); sigTecPV.clear();
  calcPV();
}
function pvSave(){
  const d = getDocPV();
  if(!d.id){ d.id = (crypto?.randomUUID?.()||('pv_'+Date.now())); }
  const item = { id:d.id, num:d.num, date:d.date, exp:d.exp, cli:d.cli, obj:d.obj, state:d.state||'bozza', k:d.k, data:d };
  pvPut(item); saveDraftPV(); pvRender(); alert('Preventivo salvato ✅');
}
async function pvShare(){
  const d=getDocPV();
  const text=`Preventivo ${d.num}
Cliente: ${d.cli}
Oggetto: ${d.obj}
Totale: ${d.k.tot}`;
  if(navigator.share){ try{ await navigator.share({title:d.num,text, url:location.href}); }catch(e){} }
  else { await navigator.clipboard.writeText(text+'\n'+location.href); alert('Copiato negli appunti ✅'); }
}
/* stampa cliente semplificata */
function pvPrint(){
  const d = getDocPV();
  const rowsHtml=(d.rows||[]).map(r=>`<tr>
    <td>${r.d||''}</td><td style="text-align:right">${r.q||0}</td><td style="text-align:right">${fmt(r.p||0)}</td><td style="text-align:right">${fmt((r.q||0)*(r.p||0))}</td>
  </tr>`).join('');
  const tel = S.get('phone','+39 351 796 9013');
  const terms = (S.get('terms','')||'').trim();
  const termsHtml = terms? terms.replace(/\n/g,'<br>') :
  `<strong>Termini:</strong> Pagamento <strong>50%</strong> all’accettazione e <strong>50%</strong> a fine lavori.
   Il materiale resta di proprietà dell’installatore fino al saldo completo. Le firme equivalgono a firma digitale.`;
  qs('#printAreaPV').innerHTML=`
  <div style="font:14px/1.3 Arial;color:#111">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div style="width:52px;height:52px;border-radius:50%;background:#0A2E5C;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">G</div>
      <div>
        <div style="font-weight:800;font-size:18px">Giorgio — Elettricista & Antennista</div>
        <div style="color:#444">Tel. ${tel}</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div><strong>${d.num}</strong></div>
        <div>Data: ${d.date}</div>
        <div>Scadenza: ${d.exp}</div>
      </div>
    </div>
    <table style="width:100%;border-collapse:collapse;margin:8px 0">
      <tr><td style="border:1px solid #000;padding:6px"><strong>Cliente:</strong> ${d.cli||'-'}</td>
          <td style="border:1px solid #000;padding:6px"><strong>Contatto:</strong> ${d.con||'-'}</td></tr>
      <tr><td colspan="2" style="border:1px solid #000;padding:6px"><strong>Oggetto:</strong> ${d.obj||'-'}</td></tr>
    </table>
    <table style="width:100%;border-collapse:collapse;margin:8px 0">
      <thead><tr>
        <th style="border:1px solid #000;padding:6px;text-align:left">Descrizione</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Q.tà</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Prezzo</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Totale</th>
      </tr></thead>
      <tbody>${rowsHtml||''}</tbody>
    </table>
    <div style="margin:6px 0"><strong>Manodopera:</strong> ${d.moQty} ${d.moType==='ora'?'h':'gg'} × ${fmt(d.moRate)}</div>
    <div style="margin:6px 0;font-size:16px"><strong>Totale:</strong> ${d.k.tot}</div>
    <div style="margin:12px 0">${termsHtml}</div>
    <div style="display:flex;gap:20px;margin-top:20px">
      <div><div style="width:260px;height:90px;border:1px solid #000;display:flex;align-items:center;justify-content:center">
        ${d.signCli?`<img src="${d.signCli}" style="max-width:100%;max-height:100%">`:''}</div>
        <div style="font-size:12px;color:#333">Firma Cliente</div></div>
      <div><div style="width:260px;height:90px;border:1px solid #000;display:flex;align-items:center;justify-content:center">
        ${d.signTec?`<img src="${d.signTec}" style="max-width:100%;max-height:100%">`:''}</div>
        <div style="font-size:12px;color:#333">Firma Tecnico</div></div>
    </div>
  </div>`;
  window.print();
}

/* ====== Interventi (IV) ====== */
const sigCliIV = signature('#ivsg-cliente');
const sigTecIV = signature('#ivsg-tecnico');

function rowsIV(){
  return qsa('#iv-rows tr').map(tr=>({
    d: qs('.d',tr).value.trim(),
    q: +qs('.q',tr).value||0,
    p: +qs('.p',tr).value||0
  })).filter(r=>r.d||r.q||r.p);
}
function calcIV(){
  const r = rowsIV();
  const mat = r.reduce((s,v)=>s+v.q*v.p,0);
  const mo = (+qs('#ivmo-qty').value||0) * (+qs('#ivmo-rate').value||0);
  const disc = (+qs('#iv-disc').value||0)/100;
  const mark = (+qs('#iv-mark').value||0)/100;

  let matNet = mat;
  if (disc>0) matNet *= (1-disc);
  if (mark>0) matNet *= (1+mark);

  const impon = matNet + mo;
  const tot = impon;

  qs('#ivk-mat').textContent = fmt(matNet);
  qs('#ivk-mo').textContent  = fmt(mo);
  qs('#ivk-imp').textContent = fmt(impon);
  qs('#ivk-tot').textContent = fmt(tot);
  qs('#iv-tot').value = fmt(tot);
}
['#ivmo-qty','#ivmo-rate','#iv-disc','#iv-mark'].forEach(sel=>document.addEventListener('input',e=>{
  if(e.target && e.target.matches(sel)) calcIV();
},{passive:true}));

function nextNumIV(){ const k='ivCounter'; let v=+(localStorage.getItem(k)||0); v++; localStorage.setItem(k, v); return 'INT-'+String(v).padStart(4,'0'); }
function getDocIV(){
  return {
    id: crypto.randomUUID(),
    num:qs('#iv-num').value, date:qs('#iv-date').value, exp:qs('#iv-exp').value,
    state:qs('#iv-state').value,
    cli:qs('#iv-cli').value, con:qs('#iv-con').value, obj:qs('#iv-obj').value,
    moType:qs('#ivmo-type').value, moQty:+qs('#ivmo-qty').value||0, moRate:+qs('#ivmo-rate').value||0,
    rows:rowsIV(), disc:+qs('#iv-disc').value||0, mark:+qs('#iv-mark').value||0,
    k:{mat:qs('#ivk-mat').textContent, mo:qs('#ivk-mo').textContent, imp:qs('#ivk-imp').textContent, tot:qs('#ivk-tot').textContent},
    signCli:sigCliIV.data(), signTec:sigTecIV.data()
  };
}
function setDocIV(d){
  qs('#iv-num').value=d.num||nextNumIV(); qs('#iv-date').value=d.date||today(); qs('#iv-exp').value=d.exp||today();
  qs('#iv-state').value=d.state||'aperto';
  qs('#iv-cli').value=d.cli||''; qs('#iv-con').value=d.con||''; qs('#iv-obj').value=d.obj||'';
  qs('#ivmo-type').value=d.moType||'ora'; qs('#ivmo-qty').value=d.moQty||0; qs('#ivmo-rate').value=d.moRate||0;
  qs('#iv-rows').innerHTML=''; (d.rows||[]).forEach(x=>addRow('#iv-rows',x.d,x.q,x.p)); if((d.rows||[]).length===0) addRow('#iv-rows');
  qs('#iv-disc').value=d.disc||0; qs('#iv-mark').value=d.mark||0;
  if(d.signCli) sigCliIV.load(d.signCli); if(d.signTec) sigTecIV.load(d.signTec);
  calcIV();
}

/* archivio IV */
function ivAll(){ return S.get('ivItems',[]); }
function ivPut(item){ const arr=ivAll(); const i=arr.findIndex(x=>x.id===item.id); if(i>=0) arr[i]=item; else arr.unshift(item); S.set('ivItems',arr); }
function ivRender(){
  const list = ivAll();
  const q = (qs('#iv-search')?.value||'').trim().toLowerCase();
  const f = (qs('#iv-filter')?.value||'all');
  const filtered = list.filter(x=>{
    const hit = ( (x.num||'')+(x.cli||'')+(x.obj||'') ).toLowerCase().includes(q);
    const stOk = (f==='all') || (x.state===f);
    return hit && stOk;
  });
  const el = qs('#iv-list'); if(!el) return;
  el.innerHTML = filtered.length
    ? filtered.map(x=>`
      <div class="card" style="margin:6px 0; cursor:pointer" data-id="${x.id}">
        <div style="display:flex;gap:8px;align-items:center">
          <strong>${x.num}</strong>
          <span class="hint">• ${x.date} → ${x.exp}</span>
          <span class="hint">• ${x.cli||'-'}</span>
          <span class="badge" style="margin-left:8px">${x.state||'aperto'}</span>
          <span class="hint" style="margin-left:auto">${x.k?.tot||''}</span>
        </div>
        <div class="hint">${x.obj||''}</div>
      </div>`).join('')
    : '<div class="hint">Nessun elemento.</div>';

  qsa('#iv-list .card').forEach(row=>{
    row.onclick = ()=>{
      const id = row.dataset.id;
      const item = ivAll().find(x=>x.id===id);
      if(item) setDocIV(item.data);
      alert('Intervento caricato ✅');
    };
  });
}
['#iv-search','#iv-filter'].forEach(sel=>qs(sel)?.addEventListener('input',ivRender));

function newIV(){
  qs('#iv-num').value = nextNumIV();
  qs('#iv-date').value = today();
  const d = new Date(qs('#iv-date').value); d.setDate(d.getDate()+30); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  qs('#iv-exp').value = d.toISOString().slice(0,10);
  qs('#iv-state').value='aperto';
  ['#iv-cli','#iv-con','#iv-obj'].forEach(sel=>qs(sel).value='');
  qs('#ivmo-type').value='ora'; qs('#ivmo-qty').value=0; qs('#ivmo-rate').value=0;
  qs('#iv-disc').value=0; qs('#iv-mark').value=0;
  qs('#iv-rows').innerHTML=''; addRow('#iv-rows');
  sigCliIV.clear(); sigTecIV.clear();
  calcIV();
}
function ivSave(){
  const d = getDocIV();
  if(!d.id){ d.id = (crypto?.randomUUID?.()||('iv_'+Date.now())); }
  const item = { id:d.id, num:d.num, date:d.date, exp:d.exp, cli:d.cli, obj:d.obj, state:d.state||'aperto', k:d.k, data:d };
  ivPut(item); ivRender(); alert('Intervento salvato ✅');
}
async function ivShare(){
  const d=getDocIV();
  const text=`Intervento ${d.num}
Cliente: ${d.cli}
Oggetto: ${d.obj}
Totale: ${d.k.tot}`;
  if(navigator.share){ try{ await navigator.share({title:d.num,text, url:location.href}); }catch(e){} }
  else { await navigator.clipboard.writeText(text+'\n'+location.href); alert('Copiato negli appunti ✅'); }
}
/* stampa cliente semplificata */
function ivPrint(){
  const d = getDocIV();
  const rowsHtml=(d.rows||[]).map(r=>`<tr>
    <td>${r.d||''}</td><td style="text-align:right">${r.q||0}</td><td style="text-align:right">${fmt(r.p||0)}</td><td style="text-align:right">${fmt((r.q||0)*(r.p||0))}</td>
  </tr>`).join('');
  const tel = S.get('phone','+39 351 796 9013');
  const terms = (S.get('terms','')||'').trim();
  const termsHtml = terms? terms.replace(/\n/g,'<br>') :
  `<strong>Termini:</strong> Pagamento <strong>50%</strong> all’accettazione e <strong>50%</strong> a fine lavori.
   Il materiale resta di proprietà dell’installatore fino al saldo completo. Le firme equivalgono a firma digitale.`;
  qs('#printAreaIV').innerHTML=`
  <div style="font:14px/1.3 Arial;color:#111">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div style="width:52px;height:52px;border-radius:50%;background:#0A2E5C;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">G</div>
      <div>
        <div style="font-weight:800;font-size:18px">Giorgio — Elettricista & Antennista</div>
        <div style="color:#444">Tel. ${tel}</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div><strong>${d.num}</strong></div>
        <div>Data: ${d.date}</div>
        <div>Scadenza: ${d.exp}</div>
      </div>
    </div>
    <table style="width:100%;border-collapse:collapse;margin:8px 0">
      <tr><td style="border:1px solid #000;padding:6px"><strong>Cliente:</strong> ${d.cli||'-'}</td>
          <td style="border:1px solid #000;padding:6px"><strong>Contatto:</strong> ${d.con||'-'}</td></tr>
      <tr><td colspan="2" style="border:1px solid #000;padding:6px"><strong>Oggetto / Descrizione:</strong> ${d.obj||'-'}</td></tr>
    </table>
    <table style="width:100%;border-collapse:collapse;margin:8px 0">
      <thead><tr>
        <th style="border:1px solid #000;padding:6px;text-align:left">Descrizione</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Q.tà</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Prezzo</th>
        <th style="border:1px solid #000;padding:6px;text-align:right">Totale</th>
      </tr></thead>
      <tbody>${rowsHtml||''}</tbody>
    </table>
    <div style="margin:6px 0"><strong>Manodopera:</strong> ${d.moQty} ${d.moType==='ora'?'h':'gg'} × ${fmt(d.moRate)}</div>
    <div style="margin:6px 0;font-size:16px"><strong>Totale:</strong> ${d.k.tot}</div>
    <div style="margin:12px 0">${termsHtml}</div>
    <div style="display:flex;gap:20px;margin-top:20px">
      <div><div style="width:260px;height:90px;border:1px solid #000;display:flex;align-items:center;justify-content:center">
        ${d.signCli?`<img src="${d.signCli}" style="max-width:100%;max-height:100%">`:''}</div>
        <div style="font-size:12px;color:#333">Firma Cliente</div></div>
      <div><div style="width:260px;height:90px;border:1px solid #000;display:flex;align-items:center;justify-content:center">
        ${d.signTec?`<img src="${d.signTec}" style="max-width:100%;max-height:100%">`:''}</div>
        <div style="font-size:12px;color:#333">Firma Tecnico</div></div>
    </div>
  </div>`;
  window.print();
}

/* ===== Link Preventivo → Intervento ===== */
function pvToIV(){
  const p = getDocPV();
  // prepara oggetto Intervento
  const iv = {
    num: nextNumIV(),
    date: today(),
    exp: p.exp || today(),
    state: 'aperto',
    cli: p.cli, con: p.con, obj: p.obj,
    moType: p.moType, moQty: p.moQty, moRate: p.moRate,
    rows: p.rows, disc: p.disc, mark: p.mark,
    signCli: '', signTec: ''
  };
  setDocIV(iv);
  // salva subito in elenco
  const temp = getDocIV();
  const item = { id: crypto.randomUUID(), num:temp.num, date:temp.date, exp:temp.exp, cli:temp.cli, obj:temp.obj, state:'aperto', k:temp.k, data:temp };
  const all = S.get('ivItems',[]); all.unshift(item); S.set('ivItems',all); ivRender();

  // passa alla tab Interventi
  qsa('.tabs .tab').forEach(t=>t.classList.remove('active'));
  qsa('.tabs .tab')[1].classList.add('active');
  qsa('main>section').forEach(s=>s.classList.toggle('active', s.id==='iv'));
  alert('Intervento creato dal preventivo ✅');
}

/* ===== Avvio ===== */
function boot(){
  // modalità sicura: nessun SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  }
  loadBrand();

  // Preventivi
  if(!S.get('pvCounter',null)) localStorage.setItem('pvCounter','0');
  qs('#pv-num').value = nextNumPV();
  qs('#pv-date').value = today();
  const d1 = new Date(qs('#pv-date').value); d1.setDate(d1.getDate()+30); d1.setMinutes(d1.getMinutes()-d1.getTimezoneOffset());
  qs('#pv-exp').value = d1.toISOString().slice(0,10);
  qs('#pv-state').value='bozza';
  addRow('#pv-rows');
  const draftPV = S.get('draftPV',null); if(draftPV) setDocPV(draftPV);
  calcPV(); pvRender();

  // Interventi
  if(!S.get('ivCounter',null)) localStorage.setItem('ivCounter','0');
  qs('#iv-num').value = nextNumIV();
  qs('#iv-date').value = today();
  const d2 = new Date(qs('#iv-date').value); d2.setDate(d2.getDate()+30); d2.setMinutes(d2.getMinutes()-d2.getTimezoneOffset());
  qs('#iv-exp').value = d2.toISOString().slice(0,10);
  qs('#iv-state').value='aperto';
  addRow('#iv-rows');
  calcIV(); ivRender();
}
</script>
</body>
</html>
